# Kintone カスタマイズ JS 一覧（出荷管理・案件管理連携）

このディレクトリには、Kintone の「出荷管理くまポン」や関連アプリ（案件管理、商品マスタ、発注書、請求書など）の業務を自動化・効率化するための JavaScript ファイルが含まれます。

## ファイル構成と役割

### 1. `02_1_CreatePurchaseOrderRecode_241119.js`

- **役割:** 発注書・請求書・見積書の自動生成
- **機能:**
  - プロセス管理でのステータス変更に応じて、発注書／請求書／見積書アプリにレコードを作成。
  - 発注番号・請求番号の採番、納品先 ID の取得、自動リンク設定。
  - 関連レコード ID や URL を掲載依頼アプリに反映。
- **動作タイミング:** プロセス管理「発注書・請求書・見積書レコードの発行済み」時。

---

### 2. `02_1_CreateRecodes_250423.js`

- **役割:** 商品マスタ・案件管理・掲載セット数管理のレコード作成
- **機能:**
  - 商品マスタ未登録商品の自動登録。
  - 案件管理へのレコード生成（モール別の管理番号採番含む）。
  - 掲載セット数管理へのレコード生成。
  - 必要に応じて商品マスタの在庫・案件情報を更新。
- **動作タイミング:** プロセス管理「商品レコード発行済み」「案件レコード発行済み」時。

---

### 3. `02_2_SetStyle_20250423.js`

- **役割:** UI 制御（掲載残日数フィールドの編集制御）
- **機能:** 新規作成・編集画面で「掲載残日数」系フィールドを常に非活性化。

---

### 4. `02_2_SetStyle_ItemLookUp.js`

- **役割:** 商品ルックアップ関連の UI 制御
- **機能:**
  - 商品ルックアップ有無に応じた入力欄の表示/非表示切り替え。
  - ルックアップ取得項目の活性・非活性制御。
  - 新規・編集・詳細画面で動作。

---

### 5. `02_3_SetValue_FastestBestDate.js`

- **役割:** 最短賞味期限の自動設定
- **機能:** 複数商品の賞味期限から最短日付を算出し「最短賞味期限」フィールドに自動反映。

---

### 6. `02_3_SetValue_OrderStatus.js`

- **役割:** 発注・受発注ステータスの自動設定
- **機能:** 受発注日と納品日が両方入力されたらステータスを「受発注」に設定。

---

### 7. `02_3_SetValue_PostingDays.js`

- **役割:** 掲載残日数の自動計算
- **機能:** 掲載終了日または掲載終了日\_その他から残日数を算出して反映。

---

### 8. `03_3_SetValue_Tag.js`

- **役割:** タグフィールドの自動設定
- **機能:** タグ選択フィールドの値をカンマ区切りに変換し、タグフィールドに反映。

---

### 9. `案件アプリの情報更新_20250425.js`

- **役割:** 案件管理アプリへの情報同期
- **機能:** レコード保存時に、同一レコード ID で案件管理アプリの特定フィールドを更新。

---

## 読み込み順序の推奨

1. **UI 制御・表示系**

   - `02_2_SetStyle_20250423.js`
   - `02_2_SetStyle_ItemLookUp.js`

2. **自動計算・値設定系**

   - `02_3_SetValue_FastestBestDate.js`
   - `02_3_SetValue_OrderStatus.js`
   - `02_3_SetValue_PostingDays.js`
   - `03_3_SetValue_Tag.js`

3. **レコード生成・更新系**
   - `02_1_CreateRecodes_250423.js`
   - `02_1_CreatePurchaseOrderRecode_241119.js`
   - `案件アプリの情報更新_20250425.js`

---

## 🆕 Temu 対応セクション（2025-10-28）

### 🎯 概要

「売価計算（App ID: 483）」から「掲載依頼（App ID: 537）」への Temu 媒体連携をサポート。  
掲載依頼アプリ側に Temu 用フィールドを新設し、既存媒体と同様の構造でデータ送信・登録が可能になりました。

---

### 📋 追加フィールド一覧（掲載依頼アプリ）

| 項目カテゴリ | フィールド名（表示名） | フィールドコード    | 種別             | 備考                             |
| ------------ | ---------------------- | ------------------- | ---------------- | -------------------------------- |
| 採用判定     | 案件採用\_TEMU         | `案件採用_TEMU`     | チェックボックス | 売価計算で採用 ON 時に対象       |
| 商品情報     | 掲載商品名（その他）   | `掲載商品名_その他` | 文字列(1 行)     | Temu の場合、こちらに出力        |
| 売価         | 売価（税抜）\_temu     | `売価_税抜_temu`    | 数値             | 新規追加フィールド               |
| 納価         | （なし）               | —                   | —                | Temu では売価のみを採用          |
| 利益率       | HC 利益率\_temu        | `HC利益率_temu`     | 数値             | Temu 専用利益率フィールド        |
| 案件関連     | 案件グループ ID        | `案件グループID`    | 文字列(1 行)     | 売価計算との紐付けキーとして使用 |
| 識別情報     | 掲載依頼 ID            | `レコード番号`      | システム         | 既存採番機能を利用               |

---

### 🔗 連携仕様概要

- 売価計算 → 掲載依頼 へのデータ送信は `CreateRecodeToPostingRequest_250703.js` を使用。
- Temu 媒体が採用フラグ ON の場合、以下の項目を送信：
  - `案件採用_TEMU`
  - `売価_税抜_temu`
  - `HC利益率_temu`
  - `掲載商品名_その他`
  - `案件グループID`
- 既存媒体と同一の JSON 構造で POST されるため、API 側の追加設定は不要。
- 掲載依頼アプリでは、レコード番号（掲載依頼 ID）をキーに更新・新規登録を判定。

---

### ⚙️ 今後の開発予定

- Temu 掲載依頼レコード作成後の自動フロー（発注書／請求書／商品マスタ連携）の確認。
- 掲載残日数計算スクリプトで Temu 掲載期間を自動反映する改修。
- 売価計算・掲載依頼間の双方向同期（利益率・採用フラグなど）の拡張。

---

## 🧩 開発タスク一覧

1. **Temu 対応構造リファクタ**

   - **要件:** 既存の `02_1_CreateRecodes_250423.js` の媒体別処理を `HC_MALLS_CONFIG` に抽象化。  
     `Promise.allSettled()` による並列化・共通エラーハンドラを導入。  
     新媒体追加時にコード修正なしで登録可能にする。
   - **完了条件:** Temu 追加を `HC_MALLS_CONFIG` に記述するだけで動作。

2. **Temu フィールド連携実装**

   - **要件:** 掲載依頼（App ID: 537）に `案件採用_TEMU`, `売価_税抜_temu`, `HC利益率_temu`, `掲載商品名_その他`, `案件グループID` を連携。  
     売価計算からのデータ送信スクリプト `CreateRecodeToPostingRequest_250703.js` を改修。
   - **完了条件:** Temu 採用時に掲載依頼へ正しく反映される。

3. **構造的改善（共通関数導入）**

   - **要件:** 日付・採番・ログ処理・API 呼出の共通関数化。  
     `formatMallNumber()`, `handleError()`, `applyMallSpecificRules()` などの追加。
   - **完了条件:** 共通関数群を別モジュール化し、既存コードから参照。

4. **掲載依頼 → 発注／請求／案件自動連携**

   - **要件:** Temu 掲載依頼レコード作成後に、既存の自動フローで発注書／請求書／案件レコードが生成されることを確認。  
     必要に応じて `02_1_CreatePurchaseOrderRecode_241119.js` を改修。
   - **完了条件:** Temu レコード作成後も従来媒体と同等のフローが動作。

5. **掲載残日数スクリプト拡張**

   - **要件:** `02_3_SetValue_PostingDays.js` に Temu 掲載終了日を参照対象として追加。  
     残日数を自動計算し、一覧画面に反映。
   - **完了条件:** Temu 残日数フィールドが自動算出される。

6. **双方向同期強化**
   - **要件:** 売価計算 ↔ 掲載依頼間で `採用フラグ`・`利益率` を同期更新可能にする。  
     現状は片方向（売価計算 → 掲載依頼）のみ。
   - **完了条件:** 双方向更新時に不整合が発生しない。

---

※タスク完了後は README から該当項目を削除していく運用とする。

---

## 🧩 共通ファイル利用ルール（2025-10-28 追加）

### 📁 構成概要

掲載依頼アプリでは、共通フォルダ（`/共通`）内の下記 2 ファイルを使用します。

| 読み込み順 | ファイル名                | 役割                                                                   | 備考                       |
| ---------- | ------------------------- | ---------------------------------------------------------------------- | -------------------------- |
| ①          | `共通/HC_MALLS_CONFIG.js` | 各媒体の構成設定（フィールド接頭辞、コスト有無、利益率有無など）を定義 | 各媒体の処理分岐を統一管理 |
| ②          | `共通/CommonUtils.js`     | 共通関数群（採番、日付変換、エラー処理、媒体固有ルールなど）           | 他のアプリと共通で利用     |

これらはアプリ固有 JS よりも **必ず先に読み込む必要があります**。

---

### 🧭 推奨読み込み順序（掲載依頼アプリ）

| 読み込み順 | ファイル名                                 | 主な内容                              |
| ---------- | ------------------------------------------ | ------------------------------------- |
| ①          | `共通/HC_MALLS_CONFIG.js`                  | 各媒体設定の初期化（Temu 対応含む）   |
| ②          | `共通/CommonUtils.js`                      | 共通関数のロード                      |
| ③          | `02_2_SetStyle_20250423.js`                | UI 制御（掲載残日数フィールド非活性） |
| ④          | `02_2_SetStyle_ItemLookUp.js`              | ルックアップ関連 UI 制御              |
| ⑤          | `02_3_SetValue_FastestBestDate.js`         | 最短賞味期限の自動設定                |
| ⑥          | `02_3_SetValue_OrderStatus.js`             | 発注・受発注ステータスの自動設定      |
| ⑦          | `02_3_SetValue_PostingDays.js`             | 掲載残日数の自動計算（Temu 対応予定） |
| ⑧          | `03_3_SetValue_Tag.js`                     | タグフィールド自動設定                |
| ⑨          | `02_1_CreateRecodes_250423.js`             | 商品マスタ・案件管理レコード生成      |
| ⑩          | `02_1_CreatePurchaseOrderRecode_241119.js` | 発注書／請求書レコード生成            |
| ⑪          | `案件アプリの情報更新_20250425.js`         | 案件管理アプリへの情報同期            |

---

### ⚙️ 利用ポリシー

1. **共通フォルダの改修は全アプリ共通で反映すること。**  
   個別アプリで独自修正を行わない。
2. **新媒体追加時は、まず `HC_MALLS_CONFIG.js` に定義を追加する。**  
   その後、掲載依頼／売価計算アプリでの処理連携を実装。
3. **各アプリで同一版を使用し、バージョン差異を残さない。**

---

### 🔧 目的

- 各媒体の追加（例：Temu、FiNC、WELBOX）時にコード修正不要化。
- 売価計算 ↔ 掲載依頼 間の処理統一。
- メンテナンス効率と動作安定性の向上。

---

## 🗓️ 進捗記録（2025-10-28）

### ✅ 本日実施した作業

1. **Temu 対応環境構築**

   - `共通/HC_MALLS_CONFIG.js` および `共通/CommonUtils.js` を掲載依頼アプリに導入。
   - Temu 用フィールドを掲載依頼アプリに新設（案件採用*TEMU、売価*税抜*temu、HC 利益率\_temu、掲載商品名*その他、案件グループ ID）。
   - `02_1_CreateRecodes_250423.js` に Temu 分岐処理を追加し、共通設定を参照できる構造に変更。
   - 共通フォルダ利用ルールおよび読み込み順序を README に反映。

2. **動作テスト準備**
   - 「商品レコード発行に進む」および「案件レコード発行に進む」手順を整理。
   - 商品掲載アプリでの Temu レコード作成テストを他メンバーに依頼。
   - エラーログ・API 通信確認ポイントを定義。

---

### 🚧 今後の作業予定

1. **Temu レコード作成テスト結果の確認**

   - 商品レコード発行後に案件レコード発行ステップで Temu レコードが生成されるかを確認。
   - 発行されたレコードが「案件管理（App ID: 514）」に正しく登録されているか検証。
   - コンソールログおよび `CreateRecodeToMatterApp()` の挙動を確認。

2. **共通モジュール連携テスト**

   - `HC_MALLS_CONFIG.js` の設定が売価計算・掲載依頼間で正しく参照されるかを検証。
   - 参照エラー（CORS、Promise 未解決など）の確認。

3. **掲載残日数計算スクリプトの Temu 対応**

   - `02_3_SetValue_PostingDays.js` に Temu 掲載終了日を追加。
   - Temu 残日数フィールドの自動反映を確認。

4. **双方向同期強化**
   - 売価計算 ↔ 掲載依頼間で「採用フラグ」「利益率」同期を実装予定。
   - `案件アプリの情報更新_20250425.js` の拡張検討。

---

### 🧭 備考

- Temu は新媒体追加のテストケースとして実装。
- 他媒体（FiNC、WELBOX など）は Temu の安定稼働後、順次共通構造へ移行予定。
- README はタスク完了ごとに更新・整理を行う。

---
