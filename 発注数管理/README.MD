# 発注数管理アプリ カスタム JS 仕様

このアプリでは、以下のカスタム JS を利用して発注数の収集・可視化・発注書作成を行っています。

---

## 📄 0\_出荷管理 BEAUTH から発注数を収集\_250216.js

### 概要

- 出荷管理（EECOTO/BEAUTH）の注文実績を**発注数管理アプリ**に取り込む処理。
- 指定ビュー（6428024）にボタン「出荷管理 BEAUTH から発注数を収集」を設置し、クリックで実行。

### 主な機能

- 出荷管理 EECOTO から**注文日・数量・案件グループ ID**を取得
- 案件管理で該当案件を特定し、発注数管理に月次レコードを作成/更新
- `day_◯` フィールドに数量を加算
- 出荷管理側にフラグ「発注数管理にカウント＝済」を更新  
  2025-10-23 修正：id 未定義エラー修正、addRecord 安全化、100 件単位更新対応。

---

## 📄 1\_発注数の推移を表示\_250508_3.js

### 概要

- 発注数管理アプリのデータをもとに**案件ごとの発注推移をスプレッドシート形式で可視化**。
- 直近 29 日分の `day_◯` を表示し、申込数の自動集計や色付けを行う。

### 主な機能

- 案件管理・掲載セット数管理と突合し、案件情報を整形
- jspreadsheet でスプレッドシート表示
- 日付範囲指定（DatePicker）と「表示を更新」ボタンを提供
- 対象期間セルのハイライト

---

## 📄 2\_発注書を作成\_250611_2.js

### 概要

- スプレッドシート（上記 #1）でチェックされた案件をもとに**発注書を生成**。
- CSV 出力または**発注書アプリ**へのレコード追加/更新を実行。

### 主な機能

- 案件管理・商品マスタ・在庫・取引先・納品先・休業日を参照
- セット入数や発注単位（バラ/ボール/ケース/最低ケース）を考慮し、発注数を自動計算
- 発注番号（HCH-YYYYMMDD-###）を発番し、案件単位でまとめて登録
- 本番モードでは「前回発注日」「前回発注数」を更新
- 下書きモードでは発注書 ID や発注番号を保持

---

## 📄 3_SDGs 用出荷依頼データを登録\_250317.js

### 概要

- ダッシュボード（#1 のスプレッドシート）から、**SDGs 対象媒体（au / Ponta パス / T サンプル / V サンプル）**を抽出し、出荷指示アプリに登録する処理。

### 主な機能

- 申込数 > 0 の案件を対象に抽出
- 案件管理・商品マスタから商品情報を参照
- 出荷指示アプリに一括登録（案件 ID・商品コード・数量・賞味期限など）

---

## 📄 4_SDGs 用発注書 CSV 出力\_250529_4.js

### 概要

- SDGs 対象媒体（au / Ponta パス / T サンプル / V サンプル）の発注データをもとに、**発注書 CSV ファイルを自動生成する処理**。
- 案件管理および休業日カレンダーを参照し、**リードタイム・休業日を考慮した発送日を自動算出**。
- 発注先未設定案件はスキップし、**別ファイルとしてエラーログ（発注エラー一覧）を出力**する安全設計。

### 主な機能

- jspreadsheet 上のデータから、申込数 > 0 の SDGs 媒体レコードを抽出。
- 案件管理・休業日カレンダーからデータ取得し、発送日を自動算出（例：10 日＋次の火曜日／休業日は後ろ倒し）。
- 長納期企業（加藤産業・UHA 味覚糖など）は発送日をさらに 7 日加算。
- 媒体別に発注書 CSV を生成し、ファイル名は「YYYYMMDD*媒体名*発注書.csv」形式で出力。
- 発注先未設定案件を別 CSV（「YYYYMMDD\_発注エラー.csv」）として保存。
- Luxon ライブラリによる日付演算、KintoneRestAPIClient によるレコード取得を採用。
- ログ出力で処理件数・スキップ件数を記録（将来的な Logger 統合を想定）。

---

## 🔗 推奨読み込み順

1. **1\_発注数の推移を表示\_250508_3.js**（ダッシュボード生成）
2. **2\_発注書を作成\_250611_2.js**（発注書作成機能）
3. **3_SDGs 用出荷依頼データを登録\_250317.js**（SDGs 出荷依頼）
4. **0\_出荷管理 BEAUTH から発注数を収集\_250216.js**（発注数の収集）

※ 運用上は「収集 (#0) → 可視化 (#1) → 発注 (#2) / 出荷 (#3)」の流れ。

---

## 📝 注意事項

- 各 JS は `KintoneRestAPIClient` を利用しており、件数制限に注意。
- グローバル定義 `HC.apps` のアプリ ID 設定が前提。
- 発注書の発番ルールは「HCH-YYYYMMDD-連番」。
- 出荷管理 EECOTO 側の「発注数管理にカウント」フラグは再取込時の重複防止に利用。

---

## 🧩 2025-10-23 修正履歴

- 出荷管理 BEAUTH から発注数収集ボタンの動作不具合を調査。
- `Cannot read properties of undefined (reading 'id')` エラーの原因を特定し、未定義参照の修正を実施。
- `updateAllRecords` を 100 件単位のチャンク処理に変更し、400 Bad Request 対策を完了。
- `addRecord` 後の `getRecord` 再取得でレコード生成の安全化を実施。
- `day_x` フィールド加算時に未定義値を `0` 扱いに変更。
- 出荷管理 BEAUTH の取得条件を再確認し、フィルタ式を改良。
- 発注数管理および出荷管理両方の更新ロジックを安全化。
- `location.reload(true)` を `location.reload()` に変更（非推奨引数削除）。
- コンソールログ出力整理とトレース手順確認。

---

## 🧩 2025-10-24 追記・作業記録

### 本日の対応内容

- 「出荷管理 BEAUTH」連携処理（0\_出荷管理 BEAUTH から発注数を収集\_250216.js）の最終構成確認と安全化レビューを実施。

  - Luxon を利用した日付安全化処理の動作を確認。
  - `getRecord()`再取得リトライ（1 秒遅延 1 回再試行）を導入し、通信遅延時でも安定動作を確認。
  - `arrAllOrderNums`の宣言位置を整理し、スコープの明確化を実施。
  - `MEDIA_CODE = 'eecoto'` を導入し、BEAUTH 対応を確立。
  - console ログや update 件数ログの整備を提案。

- 新規スクリプト `4_SDGs用発注書CSV出力_250529_4.js` を解析。
  - SDGs 対象媒体（au / Ponta パス / T サンプル / V サンプル）の発注データを CSV として自動出力する仕組み。
  - 案件管理・休業日カレンダーからデータを取得し、適切な発送日を算出（休業日を考慮して後ろ倒し）。
  - 長納期企業（加藤産業・UHA 味覚糖など）はリードタイムを 7 日延長する仕様。
  - 媒体別に CSV ファイルを分割生成（例：YYYYMMDD*媒体名*発注書.csv）。
  - 発注先未設定案件を検出し、別 CSV（発注エラー一覧）を出力する安全設計。
  - Luxon で日付演算、KintoneRestAPIClient でのデータ取得を実装。

### 改善提案

- CSV 列マッピングを明示的に定義し、列追加・変更時の保守性を向上させる。
- 案件管理および休業日カレンダー API 呼び出しを Promise.all で並列化し、実行時間短縮を検討。
- 発注先設定やリードタイム管理を外部マスタ化し、静的定義から脱却。
- 休業日ロジックを関数化し、再利用性と可読性を向上させる。
- ログ出力を共通 Logger に統一してメンテナンス性を向上。

### 補足

- 両スクリプトの動作に関する検証ログを記録し、Notion 上でドキュメント化予定。
- 発注数管理と出荷管理の同期機構は安定稼働を確認済み。
