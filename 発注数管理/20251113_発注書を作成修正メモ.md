⸻

🗒️ 2025/11/13（木） 発注書アプリ不具合調査・修正・要件整理まとめ（完全版）

⸻

✅ 1. 今日やったこと（実作業）

1-1. 発注書アプリの 400 エラー調査
• 発注書作成ボタン押下時に
POST /k/v1/bulkRequest.json → 400 Bad Request
が発生していたため、詳細ログを解析。
• ログから判明したエラー内容：

records[x].納品先情報.value: 必須です

30 件以上で 納品先情報が空エラー。

⸻

1-2. エラー原因の特定
• 発注書アプリのフィールド仕様を確認し、
「納品先」(ルックアップ) と「納品先情報」(ルックアップコピー) が必須であることを確認。
• ルックアップの自動入力は
画面操作時のみ発動し、API 登録では動かない
→ つまり、recordData に自分で値をセットしないと必ずエラーになる。

⸻

1-3. 納品先マスタの確認
• App 485「納品先マスタ」をチェックし、
“納品先名” → “納品先情報”
の対応表を確認（画像参照済み）。
• マスタ構造が API で取得できることも確認済み。

⸻

1-4. 必須項目を埋めるための修正方針を確定

以下の 2 つを発注書作成処理で 必ず recordData にセットする方針で確定：
• 納品先
• 納品先情報

→ ルックアップは API では発火しないため、
　マスタから取得して手動で recordData に埋める形に変更。

⸻

1-5. getDeliveryInfo() の仕様決定

発注書作成処理内で使う 納品先マスタ API 取得関数を設計：

async function getDeliveryInfo(name) {
const body = {
app: 485,
query: `納品先名 = "${name}"`,
fields: ["納品先名", "納品先情報"]
};

const resp = await kintone.api(kintone.api.url('/k/v1/records', true), 'GET', body);

if (resp.records.length === 0) {
throw new Error(`納品先名 ${name} のマスタが見つかりません`);
}

return resp.records[0]['納品先情報'].value;
}

⸻

1-6. recordData にセットする仕様も確定

recordData["納品先"] = { value: deliveryName };
recordData["納品先情報"] = { value: deliveryInfo };

これにより 全件で「納品先情報が必須」エラーが解消される予定。

⸻

1-7. CSV ダウンロードされない問題の根本原因を判明
• 発注書作成ボタン押下 → bulkRequest 実行 → 必須項目エラーで停止
→ 後続処理（CSV 出力）が動かなくなる
という流れを確認。

⸻

1-8. エラーログの送信範囲を明確化
• ログのどこからどこまで送れば解析できるかを確定し、
今後のトラブル時にすぐチェックできるように整理。

⸻

🚨 2. 今日確定した“要件”の追記

📌 発注書アプリの仕様（確定した要件）

項目 種類 必須 API 時
納品先 ルックアップ 必須 自動入力されない
納品先情報 文字列（ルックアップコピー） 必須 自動入力されない（自前でセット必須）

👉 結論：発注書作成時は、この 2 項目を必ず recordData にセットすることが要件。

⸻

📌 運用側の追加要件（ユーザー発言に基づく） 1. 納品先は基本固定だが、イレギュラーで変更されることがある
• → 発注処理ごとに「どの納品先を使うか」を動的に決定するロジックが必要。 2. 納品先名 → 納品先情報 のマスタは必ず存在する（App 485）
• → よって、マスタから情報を取得してセットすれば正しく動作。 3. 今日は先方へ追加要件を確認中のため、一旦作業停止
• → 納品先の決定ルールが確定したら実装再開。

⸻

🔧 3. 今後やるべきこと（作業タスク一覧）

優先度：S（必須）

① 必須項目（納品先・納品先情報）の自動セットを実装
• 発注書作成処理の recordData にセットするコードを追加する
• 納品先名はロジックで決定 → 納品先マスタを参照
• 全レコードでエラーが消えるか検証

⸻

② CSV ダウンロード復旧の確認
• 発注書作成処理がエラーなく通るようになれば、
自動的に CSV 出力も復旧する
• 実際にボタン押下 → CSV 出力まで動作を確認

⸻

優先度：A（要件決定後すぐ実装）

③ “納品先をどう決定するか”の要件を先方から確定
例：
• 案件ごとに固定？
• 媒体ごとに固定？
• 取引先マスタの情報を使う？
• ケースによって切り替わる？

→ 確定したらロジック実装可能。

⸻

優先度：B（将来リスク回避）

④ 発注書作成時の事前チェック追加
• 納品先マスタ存在チェック
• 必須項目の埋まり具合チェック
• エラー時の “まとめログ” を UI に表示（SweetAlert）

⸻

⑤ 発注書アプリのフィールド仕様を README に明確化
• 必須フィールド一覧
• ルックアップの挙動（API 動作しない）
• マスタ参照方法
• 発注番号仕様

→ 今後の改修時に迷わない。

⸻

📚 4. Notion 記録としての最終まとめ

今日の作業は以下の 3 点に分類： 1. 原因特定 → 納品先情報が必須で API 自動入力されない 2. マスタ取得 → recordData に手動でセットする仕様に確定 3. 要件整理 → 納品先選択ロジックは要確認につき保留

エラー解消後は CSV 出力も復旧する見込み。

⸻
以下に、あなたが今 Notion に貼った 11/14 作業まとめ（md）に “そのまま追記できる文章” を作りました。

📌 追記内容の前提
• 11/14 の作業全体を受けて、次回作業時の注意点
• 今日判明した フィールド仕様・リスク・実装方針の補足
• md ファイルとして読みやすい構成

そのままコピペで使えます。

⸻

🧩 追記用セクション（Notion / md 用）

⸻

🔍 追加メモ（補足事項・確定した仕様の深掘り）

今回の調査で、新しく把握できたポイント・誤解しやすい仕様を明確化するため、以下の補足を追記します。

⸻

### 1. ルックアップは “API では絶対に動かない” 仕様である

今回の障害で決定的だったのは：

kintone の Lookup は、画面操作でのみ発火する。
API で登録・更新する場合は、Lookup コピー項目は “空のまま”

これが仕様として確定した。

そのため、今後同種のアプリを実装するときも
「Lookup を使ってるから自動で入るだろう」という想定は NG
と明確に記録しておく必要がある。

⸻

### 2. “納品先” と “納品先情報” のペアは完全にセットで扱う

発注書アプリの必須項目：

項目名 種別 必須 API 動作 備考
納品先 ルックアップ 必須 自動入力されない マスタキー
納品先情報 文字列（ルックアップコピー） 必須 自動で入らない 自前セット必須

👉 納品先だけ埋めても意味がない
👉 納品先情報が空だと API は必ず 400 を返す

今回のエラーはこれが直接原因だった。

⸻

### 3. フィールドコードとラベル名は混乱しやすいので整理必須

発注書アプリでは、画面上に「納品先」は存在するが、
「納品先情報」が画面から見えづらく、気付きにくい仕様だったためエラーに繋がった。

次の点を今後のプロジェクトで再発防止として記録：
• 画面に出てくるラベル ≠ フィールドコード
• 必須チェックはラベルではなく フィールドコード基準
• 特に Lookup 周りはコードがずれてるケースが多いので注意

⸻

### 4. “発注先名” は 2 種類のフィールド表記が存在し得るため、柔軟に取得

今日の会話を踏まえて、以下の仕様も確定：

// 発注先 or 発注先名 のどちらでも拾える安全版
const 発注先名\_value =
orderRecords.find((r) => r['発注先'])?.['発注先'] ||
orderRecords.find((r) => r['発注先名'])?.['発注先名'] ||
'';

    •	実際に利用されるキーは 「ハッピーキャンペーン柏センター」
    •	もう1つは 「(株)パスクリエ　嵐山センター（SDGs）」
    •	このどちらも期待通り拾える仕様で問題なし

⸻

### 5. 今日の作業で見えた “隠れリスク” のまとめ

今回のエラー調査から見えた、潜在的リスクを記録：
• 発注書は 30 件以上の大量処理 → 1 件でもエラーがあると全体が停止
• CSV 出力は bulkRequest 完了を前提 としているため、
　 1 レコードの不備 → CSV まで止まる
• 発注処理は業務的に重要度が高いため、
　事前バリデーションの強化 が必要（要改善タスクに追加）

⸻

### 6. 今後の実装では “Lookup を使っているアプリ全て” に注意が必要

今回の仕様は発注書アプリだけの問題ではなく、

Kintone の Lookup を使う全アプリで必ず再発する可能性がある

ため、以下を README に今後必ず追記する方針を確定：
• Lookup は API で自動入力されない（必須項目の場合、必ず落ちる）
• ルックアップコピーは API で自分で埋める必要がある
• マスタデータを取得するためのユーティリティ（getMasterRecord）を共通化する

⸻

### 7. 明日の開始地点（メモ）

次回作業をスムーズに再開するためのメモ：
• 発注書作成ロジックに getDeliveryInfo() を組み込み、
　 recordData["納品先情報"] にセットする部分を実装する
• “どの発注先を使うか” のロジックを待つ
　（現時点ではハッピーキャンペーン柏センターで仮決め）

⸻

⸻

✔️ 以上を追記すれば、11/14 の作業ログは 完全版 になります。

必要なら、
・Notion 用テンプレ版
・GitHub の README.md 追記版
・Kintone 開発用メモテンプレ
にも整形できます。

続けますか？
