# 🧾 HC 新媒体追加時の作業メモ（共通テンプレート）

> 🆕 2025-10-21 更新：売価計算 TEMU/WELBOX 対応版を安定動作版として確定。

## 📘 概要

本ドキュメントは、HC システム（Kintone / GAS 連携）に **新しい媒体を追加する際の共通手順** を整理したものです。  
対象範囲は以下の通りです：

- 発注数取込処理（GAS）
- 出荷管理アプリ（媒体別）
- 出荷指示アプリ（統合側）
- 売価計算アプリ（App ID: 483）
- 掲載媒体マスタ（App ID: 520）

---

## 🧭 全体フロー

1. **媒体マスタ登録**
2. **GAS 側ロジック追加**
3. **Kintone 出荷管理アプリ作成（媒体別）**
4. **出荷指示アプリへの連携設定**
5. **売価計算・利益計算枠の追加**
6. **テスト・運用反映**

---

## 🗂 1️⃣ 掲載媒体マスタ登録

- アプリ ID：`520`
- フィールド：
  - 掲載媒体名コード（半角英数）
  - 掲載媒体名（日本語）

例：

| 掲載媒体名コード | 掲載媒体名 |
| ---------------- | ---------- |
| TEMU             | TEMU       |
| WELBOX           | WELBOX     |

> この登録が行われないと、各アプリの媒体判定や連携が動作しません。

---

## ⚙️ 2️⃣ GAS 側の対応

対象：`発注数取込_くまポン.js` および共通モジュール (`ApplicationBatchUtil`, `PostShippingDataToKintoneUtil` 等)

| 手順 | 内容                                                                  |
| ---- | --------------------------------------------------------------------- |
| 1    | `HEADERS_*` に新媒体のヘッダー定義を追加                              |
| 2    | `detectMediaFromHeader_()` に媒体判定条件を追加                       |
| 3    | `GetSheetData()` でヘッダー切替ロジックを追加                         |
| 4    | `ApplicationBatchUtil.js` の `MALL_INFO` に媒体名・サフィックスを追加 |
| 5    | デバッグ実行 (`ApplicationBatch_Main()`) でデータ取込を確認           |
| 6    | 正常動作後、`DEBUG` フラグを OFF にして GitHub に push                |

7. 発注数管理（App ID: 594）およびセット数管理（App ID: 501）との連携確認
   - `updateAllRecordsSafe()` を使用し、100 件単位で更新を行う
   - `id` 未定義エラー防止ロジック（存在チェック）を追加
   - `console.log` で各アプリの取得件数を確認（例：出荷管理 [], 発注数管理 (992), セット数管理 (1465)）

---

## 📦 3️⃣ 出荷管理アプリ（媒体別）

1. **既存アプリ（例：出荷管理くまポン）をコピー**
2. アプリ名とビュー名を新媒体名に変更
3. 以下の JS ファイルを新規作成（例：`出荷依頼データ取込_新媒体.js`, `消込データCSV出力_新媒体.js`）
4. 各 JS の設定：

| 項目             | 内容                                                     |
| ---------------- | -------------------------------------------------------- |
| ビュー ID        | 媒体専用ビューを設定                                     |
| 出荷依頼取込     | GAS 経由で受信したデータを登録                           |
| 消込 CSV 出力    | 出力後、「運用ステータス」を `消込データ出力済み` に更新 |
| ファイル名ルール | `yyyyMMdd_媒体名_消込用_配送業者.csv`                    |

> 🆕 追加情報（2025-10-23 更新）  
> BEAUTH 版では Kintone API 認証トークンを利用し、100 件単位でのレコード更新・安全化を実装済み。  
> 既存の出荷管理アプリにも順次適用予定。

---

## 📮 4️⃣ 出荷指示アプリ（App ID: 583）

- スクリプト：`0_各モールの注文データを収集_*.js`
- 対応箇所：
  - 各モール一覧 (`MALL_LIST`) に新媒体を追加
  - 出荷管理アプリ ID の登録
  - `CreateDataForShipInstruction_*` にマッピングを追加
  - 記事欄自動入力ルールを必要に応じて設定（例：`記事欄1 = "WELBOX"`）

> テストビュー ID: `6428047`  
> 登録結果に新媒体が反映されていることを確認。

---

## 💰 5️⃣ 売価計算アプリ（App ID: 483）

※ 2025-10-21 時点で TEMU / WELBOX の売価計算枠を追加・安定動作確認済。

新媒体に関する価格・利益計算を行うための枠を追加。

### 手順概要

1. 既存媒体（例：社販）の枠をコピー
2. フィールド名・コードを新媒体用に変更
3. 計算式の参照を全て新媒体コードに置換
4. 計算動作をテスト

### 追加フィールド例

| 項目               | 入力方法         | 備考                    |
| ------------------ | ---------------- | ----------------------- |
| 案件採用（新媒体） | チェックボックス | 採用可否                |
| 新媒体セット数     | 手入力           | セット数を入力          |
| 納価（税抜）       | 手入力           | 仕入値                  |
| 売上（税抜）       | 計算式           | 例：`セット数 × 単価`   |
| HC 利益（税抜）    | 計算式           | 例：`売上 - 原価`       |
| HC 利益率          | 計算式           | 例：`利益 ÷ 売上 × 100` |
| セット利益         | 計算式           | 例：`利益 ÷ セット数`   |
| 損益分岐点         | 計算式           | 例：`固定費 ÷ 利益率`   |

### 追加情報

- 売価計算アプリに `InputControl.js` を導入し、入力制御を強化しています。
- 旧来の `SetStyle` 系のスクリプトは廃止し、モダンな入力制御方式に切り替えています。
- 希望小売価格および仕入れ価格はバラ入力が可能になり、柔軟な価格設定が行えます。

---

## 🧪 6️⃣ テスト・確認

| 検証項目   | 内容                                 |
| ---------- | ------------------------------------ |
| GAS        | ヘッダー判定・件数一致・Kintone 登録 |
| 出荷管理   | 出荷依頼データの取込・CSV 出力       |
| 出荷指示   | 各モール収集後、指示登録確認         |
| 売価計算   | 自動計算・利益率算出の確認           |
| 媒体マスタ | コード一致／媒体連携確認             |
| GitHub     | 修正ブランチを main へマージ         |

### 追加情報

- Git 運用ルールおよびリリース手順を遵守し、リリース前には必ずコードレビューと動作確認を実施してください。
- リリース時はタグ付けを行い、リリースノートを作成して関係者へ共有してください。

---

## ✅ 完了チェックリスト

| チェック項目                  | 状況 |
| ----------------------------- | ---- |
| 掲載媒体マスタへ登録          | ☐    |
| GAS の媒体定義追加            | ☐    |
| 出荷管理アプリ作成            | ☐    |
| 出荷指示アプリ修正            | ☐    |
| 売価計算フィールド追加        | ☐    |
| 発注数／セット数連携確認      | ☐    |
| 100 件単位更新・id 安全化確認 | ☐    |
| テスト・検証完了              | ☐    |
| README 更新／履歴残し         | ☐    |

---

## 🧱 備考

- 新媒体追加は、くまポン／WELBOX の構成をベースに行う。
- 各アプリの App ID やフィールドコードは README に明記する。
- 計算式の置換は **フィールドコード単位** で実施（名称置換禁止）。
- デバッグ・テスト環境で完了確認後に本番アプリへ反映。

---

**最終更新日:** 2025-10-21
