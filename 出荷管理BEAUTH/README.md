# 出荷管理 BEAUTH（App ID: 568）

本ディレクトリは、Kintone アプリ「出荷管理 BEAUTH」に関連するカスタムスクリプト群を管理しています。  
発注数管理（App ID: 594）との連携、出荷日更新、在庫反映、不備修正などの自動処理を行います。

---

## 📂 構成一覧と役割

| ファイル名                                         | 主な役割                                                                                                                                                                                                                      | 実行タイミング・対象                               |
| -------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------- |
| **0\_出荷管理 BEAUTH から発注数を収集\_250216.js** | 出荷管理 BEAUTH のデータ（注文日、SKU、数量など）をもとに発注数管理アプリ(594)へ転送する。完了後、発注数管理にカウントを「済」に更新。<br>2025-10-23 修正：取得クエリ条件の見直し（未処理・空欄対応）、100 件単位更新に対応。 | 出荷管理 BEAUTH アプリの「収集」ボタン押下時に実行 |
| **不備修正を出荷依頼に反映\_250216.js**            | 出荷指示アプリにおける不備修正内容（住所・氏名・電話番号など）を出荷依頼に反映する。                                                                                                                                          | 出荷指示アプリの更新イベント                       |
| **UpdateShippingDate_eecoto.js**                   | 出荷管理アプリ内の「出荷日」一括更新処理（GDL 出荷日など）。複数媒体共通ロジック。                                                                                                                                            | 出荷管理の一覧ビューで「出荷日更新」ボタン押下時   |
| **UpdateItemStock_eecoto_230117.js**               | 出荷時の在庫数更新処理。商品在庫管理アプリと連動。                                                                                                                                                                            | 出荷完了処理・バックエンド同期時                   |
| **README.md**                                      | 各 JS の役割と掲載順序の記録。Git 履歴管理方針を明示。                                                                                                                                                                        | 手動参照用                                         |

---

## 🧭 掲載順序（index.js などにまとめる場合の順）

1. 0\_出荷管理 BEAUTH から発注数を収集\_250216.js
2. 不備修正を出荷依頼に反映\_250216.js
3. UpdateShippingDate_eecoto.js
4. UpdateItemStock_eecoto_230117.js

---

## 🧱 Git 運用ルール

| 種類               | 命名規則                         | 例                                                                          |
| ------------------ | -------------------------------- | --------------------------------------------------------------------------- |
| 修正版             | `{元ファイル名}_fix_YYYYMMDD.js` | `0_出荷管理BEAUTHから発注数を収集_fix_20251023.js`                          |
| コミットメッセージ | `fix(beauth): 修正概要`          | `fix(beauth): 発注数収集App ID参照修正`                                     |
| バックアップ       | `chore(beauth): 現行状態を保存`  | `chore(beauth): 出荷管理BEAUTH現行スクリプトをバックアップ（エラー発生中）` |

---

## 🧰 今後の TODO

- [ ] 発注数収集スクリプトの App ID 修正（EECOTO→BEAUTH）
- [ ] エラーハンドリング強化（`対象レコード0件`と`API失敗`を区別）
- [ ] BEAUTH 専用の UpdateShippingDate スクリプトに分離
- [ ] README 更新（修正版適用後に履歴追記）

---

## 🧩 2025-10-23 修正履歴

- 発注数収集処理の不具合を調査し、出荷管理 BEAUTH から発注数管理への連携ロジックを全面的に確認。
- `Cannot read properties of undefined (reading 'id')` エラーの原因を特定し、App ID 参照を数値リテラル指定に変更。
- `addRecord` 後に `getRecord` を再取得する安全処理を追加。
- `day_x` フィールドの加算ロジックを未定義値でも動作するように修正。
- `updateAllRecords` を 100 件単位のチャンク処理に変更し、400 Bad Request エラーを防止。
- 出荷管理および発注数管理両方の更新処理を分割実行化。
- 取得クエリの条件を見直し、`注文日 >= LAST_MONTH()` と `数量 >= 1` の組み合わせを改良。
- `発注数管理にカウント not in ("済")` を `(発注数管理にカウント != "済" or 発注数管理にカウント = "")` に変更し、空欄レコードも取得対象に追加。
- コンソール出力とエラーハンドリングを改善し、トレース性を強化。
- README 更新ルールを統一し、発注数管理側と整合性を確認。
