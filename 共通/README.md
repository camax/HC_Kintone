# 🧩 共通フォルダ（/共通）

このフォルダは、**全 Kintone アプリ（売価計算・掲載依頼・出荷指示など）で共通利用する設定・ユーティリティ** をまとめたものです。  
媒体ごとの設定・日付処理・ログ出力・採番ロジックなど、重複しやすい処理を一元化しています。

---

## 📁 フォルダ構成

| ファイル名             | 役割                                                                         | 読み込み順 | 補足                                                                 |
| ---------------------- | ---------------------------------------------------------------------------- | ---------- | -------------------------------------------------------------------- |
| **HC_MALLS_CONFIG.js** | 各媒体の設定定義。グローバル変数 `window.HC_MALLS_CONFIG` として登録される。 | ① 最初     | 売価計算・掲載依頼アプリなど、すべてのアプリで共通利用。             |
| **CommonUtils.js**     | 共通関数群。グローバル変数 `window.HC_UTILS` として登録される。              | ② 次       | 日付フォーマット、採番生成、エラーハンドリング、媒体固有ルールなど。 |

---

## 🧭 利用方法

### 1️⃣ Kintone カスタマイズ登録順序

各アプリのカスタマイズ画面で以下の順序で登録します。

| 読み込み順 | ファイル                  | 備考                                                                                             |
| ---------- | ------------------------- | ------------------------------------------------------------------------------------------------ |
| ①          | `共通/HC_MALLS_CONFIG.js` | 各媒体設定を先に読み込む（グローバル変数化）                                                     |
| ②          | `共通/CommonUtils.js`     | 共通関数を定義。後続スクリプトから参照される。                                                   |
| ③          | 各アプリ専用スクリプト    | 例：`売価計算/CreateRecodeToPostingRequest_250703.js` や `掲載依頼/02_1_CreateRecodes_250423.js` |

⚠️ **注意:**  
読み込み順が逆になると、`HC_MALLS_CONFIG` や `HC_UTILS` が未定義となりエラーが発生します。

---

## 🧩 HC_MALLS_CONFIG.js 概要

各媒体の設定情報を定義するファイルです。  
設定はすべて `window.HC_MALLS_CONFIG` に格納され、他スクリプトから参照されます。

```js
// 共通/HC_MALLS_CONFIG.js
window.HC_MALLS_CONFIG = {
  // au PAY マーケット
  au: { fieldPrefix: 'au', hasCost: false, hasProfit: true },

  // リロクラブ（福利厚生倶楽部）
  リロ: { fieldPrefix: 'リロ', hasCost: true, hasProfit: true },

  // eecoto（環境モール）
  eecoto: { fieldPrefix: 'eecoto', hasCost: false, hasProfit: true },

  // Temu（新媒体）2025-10-28追加
  temu: { fieldPrefix: 'temu', hasCost: false, hasProfit: true },
};
```

### 主なキー説明

| キー名        | 型      | 内容                                                    |
| ------------- | ------- | ------------------------------------------------------- |
| `fieldPrefix` | string  | 各媒体のフィールド接頭辞（例：`売価_税抜_au` の「au」） |
| `hasCost`     | boolean | 納価（原価）フィールドを持つか                          |
| `hasProfit`   | boolean | 利益率を持つか                                          |

---

## 🧰 CommonUtils.js 概要

共通関数を定義するファイルです。  
`window.HC_UTILS` に格納され、他スクリプトから参照します。

### 関数一覧

| 関数名                                 | 概要                                              | 使用例                                                |
| -------------------------------------- | ------------------------------------------------- | ----------------------------------------------------- |
| `formatDate(date)`                     | 日付を `"YYYY-MM-DD"` 形式に整形。                | `HC_UTILS.formatDate(new Date())`                     |
| `formatMallNumber(mall, dateStr)`      | 媒体コード＋日付で採番を生成。                    | `HC_UTILS.formatMallNumber('TEMU', '20251028')`       |
| `handleError(stage, e, context)`       | 統一的なエラーハンドラ。                          | `HC_UTILS.handleError('Create', e, { mall: 'temu' })` |
| `applyMallSpecificRules(mall, record)` | 媒体固有ルールを適用（例：Temu 掲載商品名補完）。 | `HC_UTILS.applyMallSpecificRules('temu', record)`     |

---

## 🧩 運用ルール

1. **共通フォルダのファイルは全アプリで同一版を使用。**
   - 差異がある場合、先に共通版を更新してから各アプリへ適用する。
2. **新媒体追加時は必ず `HC_MALLS_CONFIG.js` に定義を追加。**
3. **エラーやフォーマット修正時は `CommonUtils.js` に統一実装を追記。**
4. **修正内容は `新媒体追加時のやること.md` に記録。**

---

## 🧱 今後の拡張予定

- `HC_UTILS` に以下の共通機能を追加予定：
  - API 通信ラッパ（kintone.api を Promise で扱う）
  - ログ記録・通知（Slack/メール送信）
  - 時間・日付関連のユーティリティ強化（営業日判定など）

---

## 📌 メンテナンス担当

| 項目             | 担当者                   | 備考                                 |
| ---------------- | ------------------------ | ------------------------------------ |
| 設定ファイル管理 | 鎌塚 友作（inspireApac） | 媒体構成変更時に更新                 |
| コードレビュー   | ChatGPT + Cursor         | リファクタリング時の自動チェック活用 |
