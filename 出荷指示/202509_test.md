## 総合テスト計画（全ファイル横断）

- 目的: 本番想定のデータ／操作で、正常系・境界値・エラー時の挙動とログ/更新副作用を検証する
- 前提: テスト用ビューで実行、DEBUG=true で詳細ログ確認（必要に応じて）
- 優先度ランク: **A（必須） / B（推奨） / C（仕上げ）**

---

### 1. `0_指定出荷日を入力_250217.js`（優先度 A）

- [ ] ダイアログ表示・媒体選択・日付選択ができる
- [ ] 一覧の絞込対象だけが更新される
- [ ] 全媒体／個別媒体の両方で更新成功し、**指定出荷日**が反映される
- [ ] 取消や × 閉じで更新されない（副作用なし）
- [ ] 429/5xx 等でのリトライ／エラーメッセージ表示（DEBUG ログ確認）

---

### 2. `1_出荷依頼を出力_250618_1.js`（優先度 A）

- [ ] 「出荷依頼データを DL」で CSV が落ちる（佐川／ゆうパケットの両フォーマット）
- [ ] ダウンロード後、**出荷依頼 CSV の出力日**が更新される（HC 以外のユーザ）
- [ ] 「出荷依頼データを DL(HC 確認用)」では **出力日を更新しない**
- [ ] 住所分割・電話ハイフン除去・賞味期限フォーマットが仕様通り
- [ ] レコードに商品情報が無い／必須欠落時のスキップとメッセージ

---

### 3. `2_伝票番号の取込_250213.js`（優先度 A）

- [ ] CSV 取り込み → レコード番号一致で **伝票番号/発送日/取込日** を更新
- [ ] 不正 CSV（列欠落・空行）を検出してスキップ／エラーメッセージ
- [ ] 同一レコード重複行は最後勝ち／重複警告の出力
- [ ] 取り込み後の件数サマリ表示

---

### 4. `3_出荷管理に伝票番号を反映_250225.js`（優先度 A）

- [ ] 一覧対象の出荷指示 →**媒体ごとの出荷管理**へ伝票番号/発送日などを反映
- [ ] 成功/失敗の媒体別サマリ表示
- [ ] 相手側アプリのキー不一致時にスキップ＋警告
- [ ] 429/5xx 時の再試行（指数バックオフ相当）と継続動作

---

### 5. `0_各モールの注文データを収集_250626.js`（優先度 A）

**機能横断（並列取得 / in 句取得 / 正規化 / フォールバック / 住所・電話補正）**

- 取得・統合
  - [ ] 各出荷管理から「出荷依頼」を**並列取得**、失敗媒体はスキップして続行
  - [ ] 案件/商品/在庫は **in(...)＋ 100 件チャンク**で取得（`fields` 最小化）
  - [ ] **商品コード正規化**（空白/大小/全半角）で ITEM_BY_CODE/STOCK_BY_CODE を構築
  - [ ] **在庫は賞味期限昇順**で割当（必要数ちょうど/不足/複数在庫の境界）
- フォールバック・補正
  - [ ] 倉庫 103 → 104 → 先頭 → null（媒体別：くまポン/WELBOX=103、eecoto=104 等）
  - [ ] **住所不備チェック**（郵便番号ゼロパディング、番地/市区町村、氏名空）
  - [ ] **電話番号補正**（`+81`/`81`→`0`、10/11 桁検証）
- 出荷指示レコード生成
  - [ ] **レコード URL 付与**
  - [ ] **WELBOX** → 記事欄 1 = `WELBOX`
  - [ ] **eecoto（BEAUTH）注文メモ判定**
    - `ANA` → 記事欄 5 = **ANA Pocket 分**
    - `JAL` → 記事欄 5 = **JAL ミニマイル特典分**
    - `ANA` と `JAL` 両方 → **ANA を優先**
    - 大文字小文字を無視（`toUpperCase().trim()`）
- 更新・ガード
  - [ ] 出荷指示に一括登録後、出荷管理側 **運用ステータス=出荷依頼済み**
  - [ ] **二重起動ガード**：処理中はボタン disable／終了で復帰
  - [ ] DEBUG=true で媒体別件数サマリと再試行ログを確認

---

### 6. `test.js`（優先度 C）

- [ ] 5 と同一動作であること（差分がないこと）
- [ ] 主要フロー（くまポン/WELBOX/eecoto）で作表一致

---

### 7. `0_BtoB_指定出荷日を入力_250221 (1).js`（優先度 A）

- [ ] 媒体（Ponta パス / V サンプル / 全体）で指定出荷日を一括更新
- [ ] 出荷指示更新後、**入出庫管理**に納品データが自動登録
- [ ] 納品予定日のロジック（指定出荷日の翌日）が正しい
- [ ] サマリ表示（登録件数/エラー件数）

---

### 9. `1_BtoB_出荷依頼を出力_250618_1.js`（優先度 A）

- [ ] 「BtoB 出荷依頼データを DL」で CSV 生成・ダウンロード
- [ ] ダウンロード後に **出荷依頼 CSV の出力日** が更新
- [ ] 「テスト: CSV DL」はファイル名に `_TEST` が付与、出力日更新は同じ挙動か仕様通り
- [ ] ご依頼主電話番号の自動補正（媒体/ご依頼主名に基づく）

---

### 10. `1_出荷依頼を出力_250618_1.js`（HC 例外含む／優先度 A）

- [ ] 通常 DL は **出力日を更新**、HC 確認用は **更新しない**（ユーザ判定）
- [ ] 配送業者別の CSV フォーマット差を確認（列順・桁数・必須）
- [ ] 住所分割・ハイフン除去・ご依頼主コード（サイズ連動）・賞味期限変換の整合

---

### 11. `2_BtoB_伝票番号の取込_250401_3.js`（優先度 A）

- [ ] 指定出荷日 × 商品コード × 賞味期限 のキー一致で更新
- [ ] 「テスト機能実行」は**更新せず**にシミュレーションのみ
- [ ] 取込結果サマリ（更新/未一致/不正行）
- [ ] 同一キー重複の取扱い（最後勝ち or 警告）

---

### 12. `2_伝票番号の取込_250213.js`（優先度 A）

- [ ] レコード ID キーで更新（伝票番号/発送日/取込日）
- [ ] エラーファイル時の保護（未更新）＋行単位スキップ
- [ ] サマリとログ

---

### 13. `4_BtoB_ピッキング明細を出力_250526.js`（優先度 B）

- [ ] 今月/先月/先々月の選択で対象レコード抽出
- [ ] 商品情報のフラット化・ピッキング単価 × 数量の計算
- [ ] CSV の数値桁・日付フォーマット
- [ ] ファイル名に出力日＋対象月を付与

---

### 14. `4_出荷実績を出力_250330.js`（優先度 B）

- [ ] BtoB ではない伝票取り込み済みのレコード抽出
- [ ] CSV 化と列マッピング（フォーマット逸脱がない）
- [ ] 期間選択（今月/先月/先々月）で件数が変わること

---

### 15. `5_電話番号補正処理_共通*.js`（優先度 A）

- [ ] `+81xxxxxxxxx` / `81xxxxxxxxx` → `0xxxxxxxxx` に補正
- [ ] 全角数字/長音/ハイフン除去 → 10 or 11 桁バリデーション
- [ ] 未入力時はエラーを返し、既存の不備フィールドに反映（ある場合）

---

### 16. `計算_セット入数合計.js`（優先度 B）

- [ ] サブテーブル「商品情報」の**個数合計**が正しく算出
- [ ] 合計 ÷ 注文数 → **セット入数合計** を更新（小数点処理の仕様通り）
- [ ] 個数/注文数のリアルタイム再計算（create/edit の両方）
- [ ] 保存時に必ず再計算（手入力の上書き防止）

---

## 横断テスト（優先度 A）

- [ ] **権限/ロール**：HC ユーザ vs 一般ユーザでの分岐（出力日更新/不可視ボタン 等）
- [ ] **二重起動ガード**：通信遅延時にボタン多重押下を防止
- [ ] **429/5xx リトライ**：GetAllRecords と媒体取得の指数バックオフ（最大 3 回）
- [ ] **サマリ/ポップアップ**：成功/失敗件数、媒体別内訳が利用者に分かりやすい
- [ ] **エクスポート CSV の Excel 互換**：`="..."` 形式（郵便/電話）で先頭ゼロ保持
- [ ] **日付フォーマットの揺れ**：ISO/`yyyy/MM/dd`/`yyyyMMddHHmmss` の読取
- [ ] **文字種正規化**：商品コード・住所・電話の全半角/大小/長音対応
- [ ] **ログの秘匿**：DEBUG=false では機微情報を出力しない

---

## Step 3：動作テスト（くまポン／WELBOX）〔優先度 A〕

### 目的

- Map 参照化（ITEM_BY_CODE / STOCK_BY_CODE）後のフローが、くまポン／WELBOX で仕様通りに動くことを確認する。
- フォールバック・補正（倉庫・住所・電話）と媒体固有処理（記事欄 1=WELBOX）が期待通りであることを確認する。

### 前提

- テスト実行ビュー：`app.record.index.show` / viewId=6428047
- ボタン：**各モールの注文データを収集**
- DEBUG=true（必要に応じて切替）
- テストデータ：
  - 出荷管理（くまポン/WELBOX）に「出荷依頼」状態のレコードを複数用意（数量の大小・住所/電話の不備ケース混在）
  - 案件管理に媒体=くまポン or WELBOX、対応するモール管理番号を用意
  - 商品マスタ・在庫管理に対応商品（在庫：十分/不足/複数賞味期限）
  - 倉庫マスタに 103/104 を登録（103 を優先使用想定）

### 手順

1. 一覧画面でボタン **各モールの注文データを収集** をクリック
2. 完了アラート（Swal）の文面を確認（作成件数、媒体別更新サマリが出ること）
3. 出荷指示アプリ側で新規作成されたレコードを確認

### 期待結果（チェックリスト）

- 取得・突合

  - [ ] くまポン/WELBOX の **出荷依頼**が並列取得される（DEBUG ログに媒体別件数）
  - [ ] 案件管理は媒体名＋モール管理番号で **mattRec** が突合される
  - [ ] 商品コードは **normalizeCode** 済みで `ITEM_BY_CODE.get(code)` 参照（`itemRecords.find` は使われない）

- 在庫割当（STOCK_BY_CODE）

  - [ ] `STOCK_BY_CODE.get(code)` の配列から **賞味期限昇順**で割当される
  - [ ] 必要バラ数（数量 × セット入数）ちょうど／不足／複数在庫のケースで期待通りの行が選ばれる
  - [ ] 在庫消費後、`cand.在庫数.value` が差し引かれている

- 媒体固有処理

  - [ ] **WELBOX** の場合のみ、出荷指示の **記事欄 1='WELBOX'** が自動入力される
  - [ ] くまポンは記事欄 1 への自動入力なし

- 倉庫フォールバック

  - [ ] `pickWarehouse('103')` で倉庫 103 が選択される（無ければ 104 → 先頭 → null）
  - [ ] ご依頼主（103）情報が 出荷指示の **ご依頼主名/住所/郵便/電話** に反映

- 住所・電話補正

  - [ ] 郵便番号：長音/ハイフン除去、**7 桁ゼロパディング**、7 桁チェック
  - [ ] 住所：**市区町村の有無**と**番地の有無**チェック、空欄検出
  - [ ] 電話：長音/ハイフン/全角 → 半角、`+81`/`81`→`0`、**10/11 桁**チェック
  - [ ] 不備あり時は **送付先不備=不備あり** と **不備内容** 追記

- 付加情報・更新
  - [ ] **出荷管理のレコード URL** が付与されている
  - [ ] 作成後、出荷管理側の **運用ステータス=出荷依頼済み** に更新される
  - [ ] 二重起動ガード：ボタンが処理中 disable → 完了後に復帰

### ネガティブ/境界テスト

- [ ] 案件未一致：mattRec が見つからない場合、エラーログ出力＆スキップ
- [ ] 商品コード空/未登録：該当サブ行はスキップ（他行は処理継続）
- [ ] 在庫不足：**賞味期限/ロケーション/備考** が空で登録（不足マークは付けない仕様のまま）
- [ ] 住所・電話の不備が複数重なった場合、**不備内容** に改行で併記

### 成功判定

- [ ] Swal メッセージに「登録 X 件 / 失敗 Y 件」が表示され、媒体別の更新内訳も表示
- [ ] 出荷指示に想定件数が作成され、サンプル抽出で各フィールド（記事欄 1、倉庫情報、住所/電話補正）が仕様通りである
