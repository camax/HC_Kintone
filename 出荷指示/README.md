# Kintone 出荷指示アプリ カスタマイズ JS

このリポジトリは、Kintone の「出荷指示アプリ」で使用される JavaScript カスタマイズファイルを管理します。
各ファイルは特定の業務プロセスを自動化・効率化するための機能を提供します。

## ファイル構成と役割

### 1. `0_指定出荷日を入力_250217.js`

- **役割:** 指定出荷日の一括入力
- **動作ビュー ID:** `6428047`
- **機能:**
  - 一覧画面に「指定出荷日を入力」ボタンを追加します。
  - ボタンをクリックすると、対象の媒体（全媒体または個別）と出荷日を選択するダイアログが表示されます。
  - 選択された内容に基づき、一覧に表示されている対象レコードの「指定出荷日」フィールドを一括で更新します。

### 2. `1_出荷依頼を出力_250618_1.js`

- **役割:** 出荷依頼 CSV のダウンロード
- **動作ビュー ID:** `6426714`
- **機能:**
  - 一覧画面に「出荷依頼データを DL」および「出荷依頼データを DL(HC 確認用)」ボタンを追加します。
  - 一覧に表示されているレコードを元に、配送業者に応じたフォーマットで出荷依頼 CSV ファイルを生成し、ダウンロードします。
  - 通常のダウンロード（HC 確認用でない方）の場合、処理後に各レコードの「出荷依頼 CSV の出力日」フィールドを更新します。

### 3. `2_伝票番号の取込_250213.js`

- **役割:** 伝票番号 CSV の取り込み
- **動作ビュー ID:** `6427059`
- **機能:**
  - 一覧画面に「伝票番号 CSV を UL」ボタンを追加します。
  - ボタンをクリックして CSV ファイルを選択すると、ファイルの内容を読み込みます。
  - CSV に含まれるレコード番号と伝票番号をキーにして、該当するレコードの「伝票番号」「発送日」「伝票番号 CSV の取込日」フィールドを更新します。

### 4. `3_出荷管理に伝票番号を反映_250225.js`

- **役割:** 関連アプリへの伝票番号反映
- **動作ビュー ID:** `6428145`
- **機能:**
  - 一覧画面に「各モールの出荷管理に伝票番号を反映」ボタンを追加します。
  - 一覧に表示されているレコードの伝票番号や発送日などの情報を、レコードごとに指定された関連アプリ（各 EC モールの出荷管理アプリ）に転記・反映します。
  - 反映後、元の出荷指示アプリのレコードにある「出荷管理へ反映日」フィールドを更新します。

### 5. `0_各モールの注文データを収集_250626.js`

- **役割:** 各モール（くまポン、WELBOX、eecoto、リロクラブ、ベネフィット・ワン、T ポイント、社販、坂戸以外、KAUCHE）の出荷管理アプリから「出荷依頼」ステータスのレコードを収集し、出荷指示アプリに新規レコードとして登録します。
- **動作ビュー ID:** `6428047`
- **機能:**
  - 一覧画面に「各モールの注文データを収集」ボタンを追加
  - ボタンクリック時、各出荷管理アプリから「出荷依頼」ステータスのレコードを取得
  - 取得データと **案件管理 / 商品マスタ / 在庫管理 / 倉庫マスタ** を突合して出荷指示用レコードを生成
  - 生成レコードに **出荷管理のレコード URL 付与／住所不備チェック／電話番号補正** を実施
  - 出荷指示アプリへ一括登録
  - 登録後、元の出荷管理側の「運用ステータス」を **出荷依頼済み** に更新
  - 処理結果をポップアップ通知
  - **BEAUTH（Shopify / eecoto）のクーポン判定（2025-09）**: 出荷管理 BEAUTH（アプリ ID: 568）で **注文メモ**（`注文メモ`）を判定し、出荷指示（アプリ ID: 583）の **記事欄 5**（`記事欄5`）へ自動入力。
    - `ANA` を含む場合 → 「ANA Pocket 分」
    - `JAL` を含む場合 → 「JAL ミニマイル特典分」
    - それ以外（記載なし含む） → 空欄
    - 判定は大文字小文字を無視（`toUpperCase().trim()`）、両方含まれる場合は **ANA を優先**
  - **WELBOX** の場合は記事欄 1（`記事欄1`）に「WELBOX」を自動入力

（注）KAUCHE は案件管理上の媒体名「おためし」として登録されている場合があります。

## ✅ 完了した対応

### フェーズ 1〜3

- 出荷管理の取得処理を並列化し、429/5xx に対する指数バックオフを導入
- GetMatterRecords / GetItemRecords / GetStockRecords を in(...)＋チャンク化
- fields の最小化で不要フィールド削減
- UpdateAllRecords を簡易リトライ対応（429/5xx 最大 3 回）
- 更新件数を { updated, failed, error } 形式で返却
- UpdateShippingRecords を Set 化し O(N) へ短縮
- 媒体別更新サマリを Swal 表示（合計＋媒体内訳）
- 二重起動ガード、厳密比較(===)統一、ログ切替(DEBUG)、FixPhoneNumbers バグ修正

## ✅ 完了した対応（2025-10-01）

- mattRec のインデックス化を導入し、媒体＋キーで O(1) 参照可能に改善
- listMattKeysForMedia() を DEBUG ガード内に統一し、候補キー一覧はデバッグ時のみ表示
- buildMattIndex() を GetMatterRecords の重複除去後に 1 回だけ実行するよう整理
- API メトリクス計測を追加（getShip / getAll / add / update の件数・時間を出力）
- GitHub main ブランチへ反映済み

## ⏳ 残っている対応（2025-10-01 時点）

### フェーズ 4（商品/在庫参照インデックス化）

- [ ] 各 CreateDataForShipInstruction\_\* の find/filter/sort → Map 参照に置換  
       （まず「くまポン」で対応 → 他媒体へ水平展開）
- [ ] ITEM_BY_CODE / STOCK_BY_CODE の Map 利用テスト（在庫割当の境界ケース）

### フェーズ 5（安定性・快適性改善）

- [ ] 定数の先頭集約（VIEW_ID / APP_ID / CHUNK_SIZE など）
- [ ] ログ整形（通常時: 要点のみ、DEBUG 時: 詳細ログ）
- [ ] ドライランフラグ追加（更新を実施せず件数サマリだけ出力）

### フェーズ 6（仕上げ）

- [ ] 全媒体での通し確認（作成サマリ＋更新サマリの整合性）
- [ ] エラーメッセージ・コメント整理
- [ ] README / TEST_PLAN の履歴更新

---

### 6. `test.js`

- **役割:** `0_各モールの注文データを収集_250626.js` と同じ内容のテスト用ファイルです。
- **動作ビュー ID:** `6428047`
- **機能:** `0_各モールの注文データを収集_250626.js` と同様の機能を提供します。

### 7. `0_BtoB_指定出荷日を入力_250221 (1).js`

- **役割:** BtoB 案件向けに、指定した媒体（または全媒体）のレコードに対して指定出荷日を一括で設定し、関連する入出庫管理アプリに納品データを登録します。
- **動作ビュー ID:** `6428141`
- **機能:**
  - 一覧画面に「指定出荷日を入力」ボタンを追加します。
  - ボタンクリック時、対象媒体（Ponta パス、V サンプル、または全媒体）と出荷日を選択するダイアログが表示されます。
  - 選択された媒体と出荷日に基づき、一覧に表示されている対象レコードの「指定出荷日」フィールドを更新します。
  - 出荷指示アプリのレコード更新後、指定出荷日の翌日を納品予定日として、入出庫管理アプリに納品データを自動で登録します。
  - 処理結果はポップアップで通知されます。

### 9. `1_BtoB_出荷依頼を出力_250618_1.js`

- **役割:** BtoB 案件の出荷依頼データを CSV 形式でダウンロードします。
- **動作ビュー ID:** `6427848`
- **機能:**
  - 一覧画面に「BtoB 出荷依頼データを DL」ボタンと「テスト: CSV DL」ボタンを追加します。
  - 「BtoB 出荷依頼データを DL」ボタンクリック時、現在のビューに表示されているレコードから商品情報、配送先情報などを集約し、指定されたフォーマットで CSV ファイルを生成してダウンロードします。ダウンロード後、対象レコードの「出荷依頼 CSV の出力日」フィールドを更新します。
  - 「テスト: CSV DL」ボタンクリック時、同様に CSV ファイルを生成しますが、テスト用としてファイル名に`_TEST`が付与されます。
  - レコードの作成・編集時、ご依頼主名や媒体名に基づいてご依頼主電話番号を自動補正します。

### 10. `1_出荷依頼を出力_250618_1.js`

- **役割:** 出荷依頼データを CSV 形式でダウンロードします。HC（ハッピーキャンペーン）ユーザーの場合はダウンロードのみで、CSV 出力日の更新は行いません。
- **動作ビュー ID:** `6426714`
- **機能:**
  - 一覧画面に「出荷依頼データを DL」ボタンと「出荷依頼データを DL(HC 確認用)」ボタンを追加します。
  - 「出荷依頼データを DL」ボタンクリック時、現在のビューに表示されているレコードから商品情報、配送先情報などを集約し、配送業者（佐川急便、ゆうパケット）に応じたフォーマットで CSV ファイルを生成してダウンロードします。ダウンロード後、対象レコードの「出荷依頼 CSV の出力日」フィールドを更新します。
  - 「出荷依頼データを DL(HC 確認用)」ボタンクリック時も同様に CSV ファイルを生成してダウンロードしますが、HC ユーザー向けのため「出荷依頼 CSV の出力日」フィールドは更新しません。
  - レコードの作成・編集時イベントで、ご依頼主名や媒体名に基づいてご依頼主電話番号を自動補正します。
  - 住所を都道府県と市区町村以降に分割する処理を含みます。
  - CSV 出力時に、ご依頼主コード（サイズに応じて変化）、電話番号のハイフン除去、賞味期限のフォーマット変換など、項目に応じた値の変換を行います。

### 11. `2_BtoB_伝票番号の取込_250401_3.js`

- **役割:** BtoB 案件の伝票番号 CSV ファイルを取り込み、出荷指示アプリの該当レコードに伝票番号、発送日、伝票番号 CSV の取込日を反映します。
- **動作ビュー ID:** `6427850`
- **機能:**
  - 一覧画面に「BtoB 伝票番号 CSV を UL」ボタンと「テスト機能実行」ボタンを追加します。
  - ボタンクリック時、CSV ファイルを選択するダイアログが表示され、選択された CSV ファイルの内容を読み込みます。
  - CSV データと現在のビューに表示されているレコードを比較し、指定出荷日、商品コード、賞味期限が一致するレコードに対して伝票番号、発送日、伝票番号 CSV の取込日を更新します。
  - 「テスト機能実行」ボタンクリック時も同様に CSV ファイルを読み込みますが、レコードの更新は行わず、処理のシミュレーションのみを行います。
  - 処理結果はポップアップで通知されます。

### 12. `2_伝票番号の取込_250213.js`

- **役割:** 伝票番号 CSV ファイルを取り込み、出荷指示アプリの該当レコードに伝票番号、発送日、伝票番号 CSV の取込日を反映します。
- **動作ビュー ID:** `6427059`
- **機能:**
  - 一覧画面に「伝票番号 CSV を UL」ボタンを追加します。
  - ボタンクリック時、CSV ファイルを選択するダイアログが表示され、選択された CSV ファイルの内容を読み込みます。
  - CSV データ（伝票番号、レコード ID、発送日）を基に、出荷指示アプリの該当レコードを更新します。
  - 処理結果はポップアップで通知されます。

### 13. `4_BtoB_ピッキング明細を出力_250526.js`

- **役割:** BtoB 案件の伝票番号取込済みのレコードから、指定した月のピッキング費用明細を CSV 形式で出力します。
- **動作ビュー ID:** `6427852`
- **機能:**
  - 一覧画面に「BtoB ピッキング明細を出力」ボタンを追加します。
  - ボタンクリック時、出力対象の月（今月、先月、先々月）を選択するダイアログが表示されます。
  - 選択された月に該当し、かつ伝票番号が取り込まれている BtoB 案件のレコードを Kintone から取得します。
  - 取得したレコードの商品情報をフラット化し、ピッキング単価や注文数に応じた計算を行い、CSV 形式で出力します。
  - CSV ファイル名には、出力日と対象月が含まれます。
  - 処理結果はポップアップで通知されます。

### 14. `4_出荷実績を出力_250330.js`

- **役割:** 伝票番号が取り込まれたレコードから、指定した月の出荷実績を CSV 形式で出力します。BtoB 案件ではないレコードが対象です。
- **動作ビュー ID:** `6427178`
- **機能:**
  - 一覧画面に「出荷実績を出力」ボタンを追加します。
  - ボタンクリック時、出力対象の月（今月、先月、先々月）を選択するダイアログが表示されます。
  - 選択された月に該当し、かつ伝票番号が取り込まれている BtoB ではない案件のレコードを Kintone から取得します。
  - 取得したレコードの情報を CSV 形式に変換し、出力します。
  - CSV ファイル名には、出力日と対象月が含まれます。
  - 処理結果はポップアップで通知されます。

### 15. `5_電話番号補正処理_共通_250526.js`

- **役割:** 電話番号の補正処理を実行します。
- **動作ビュー ID:** 全てのビュー（`app.record.index.show`イベントでビュー ID の指定がないため）
- **機能:**
  - 一覧画面表示時に`updatePhoneNumbers`関数を実行します。
  - 「📞 電話番号補正（手動実行）」ボタンをヘッダーメニューに追加し、クリックすることで手動で`updatePhoneNumbers`関数を実行できます。
  - `updatePhoneNumbers`関数は現在仮の実装であり、具体的な電話番号補正ロジックは含まれていません（`TODO`コメントあり）。

16. 計算\_セット入数合計.js
    • 役割: サブテーブル「商品情報」の「個数」合計とレコードの「注文数」から「セット入数合計」を自動計算します。
    • 動作ビュー ID: 新規作成・編集画面（app.record.create.show, app.record.edit.show）、保存時（app.record.create.submit, app.record.edit.submit）
    • 機能:
    • サブテーブル「商品情報」内の「個数」値を合計します。
    • 合計値を「注文数」で割り、計算結果を「セット入数合計」に反映します。
    • 「個数」または「注文数」が変更された場合はリアルタイムで再計算します。
    • 保存時にも必ず再計算を行い、整合性を担保します。
    • 既存レコードについては一時的に「一括埋め込み」ボタンで更新対応済み（現在は削除済み）。

## JS ファイルの読み込み順序について

各 JavaScript ファイルは、それぞれが独立して動作するように設計されています。
具体的には、以下の理由により、**kintone のカスタマイズ設定でこれらのファイルを読み込む順番を気にする必要はありません。**

- **イベントハンドラの分離:** 各ファイルは、異なるビュー ID (`viewId`) を持つ `app.record.index.show` イベントをリッスンしており、同時に実行されることはありません。
- **スコープの独立性:** すべてのコードは即時実行関数式 `(() => { ... })();` で囲まれており、グローバルスコープの汚染を防いでいるため、ファイル間で変数名や関数名が衝突することはありません。
- **機能の独立性:** ファイル間で関数を呼び出したり、変数やオブジェクトを共有したりする依存関係はありません。

## 運用上の注意

- 429/5xx エラー時は自動リトライします。最大 3 回まで再試行するため、失敗が続く場合は処理時間が延びます。
- DEBUG フラグを true にすると詳細ログを出力します。通常運用では OFF を推奨します。
- ボタン連打を防ぐため、処理中はボタンが無効化されます。
- API メトリクス（件数・経過時間）は処理終了時にメッセージへ要約行を追記。詳細（媒体別）は DEBUG=true の時のみ console に出力。

## 変更履歴

- 2025-10-01 `0_各モールの注文データを収集_250626.js`

  - mattRec のインデックス化／DEBUG ガード統一／API メトリクス計測を追加
  - GetMatterRecords 後の重複除去 → 索引構築の順に整理

- 2025-09-26 `0_各モールの注文データを収集_250626.js`
  - 出荷管理取得を並列化＋指数バックオフを追加
  - 案件/商品/在庫取得を in 句＋チャンク化し、fields 最小化
  - 出荷管理の一括更新にリトライ・媒体別サマリを追加
  - 二重起動ガード・DEBUG 切替を実装

横展開テンプレ（最短手順） 1. 設定の辞書化
• アプリ ID、ビュー ID、媒体/キー対応、既定値（倉庫 ID・表示名など）を先頭で一元定義。
• 既存の switch／ハードコードは辞書参照に置換。 2. 参照のインデックス化（Map）
• 大きい配列検索（find/filter/sort ループ）をやっている箇所は、取得直後に
KEY → record(群) の Map を構築してから Map.get に差し替え。
• サブテーブルも、行数が多いならキー列で Map 化（例：code -> row[]）。 3. API 最小化
• 取得は fields 最小化＋ IN 句＋チャンク 100（必要に応じて可変定数化）。
• 更新は 媒体/機能単位でまとめて一括更新。
• 429/5xx は 指数バックオフ（± ジッター）で再試行。 4. DRY_RUN とメトリクス
• DRY_RUN フラグで「作成/更新を実行せずサマリだけ」モードを持つ。
• メトリクス：API 回数・取得件数・所要時間を DEBUG 時にログ出力。 5. 安全性・保守性
• 二重起動ガード（ボタン disable / スピナー）。
• idempotent になるよう、同一レコード二度処理の防御（Set/Map で重複抑止）。
• 例外は握りつぶさず媒体単位で継続・サマリに反映。 6. テスト動線
• TEST.md に「A/高」「B/中」「C/低」優先度でケースを追記。
• 少なくとも A は DRY_RUN で差し戻しなしまで確認 → 本番 ON。

ファイル種別ごとの注意点
• 一覧画面ボタン系（今回同様）
• 並列取得＋指数バックオフをそのまま流用可能。大量配列の検索は必ず Map 化。
• 新規/編集画面のハンドラ系（app.record.create.show など）
• 同期的に UI が固まりやすい。重い処理は遅延実行 or 事前インデックス。
• 入力イベントは最小限にし、デバウンス（例：300ms）を入れると体感良し。
• 保存時フック（submit 系）
• バリデーションは 早期 return でわかりやすく。
• 更新や外部参照は DRY_RUN で先に網羅確認。
• サブテーブル操作
• 行ごとの find 連打は NG。事前に Map を作ってから走査。
• 合計/再計算は 依存フィールドをイベントハンドラ 1 箇所に集約。

実装順のおすすめ（毎回同じ型で進める） 1. 先頭に 定数・辞書・フラグ（DEBUG/DRY_RUN/CHUNK_SIZE） を追加 2. 取得系を fields 最小化＋ IN 句＋チャンク に統一 3. Map 構築（取得直後）→ 参照箇所を find から Map.get に置換 4. 更新を 一括更新＋指数バックオフ 化 5. DRY_RUN/メトリクス/二重起動ガード を配線 6. TEST.md に A 優先 の通しテストを追加 → 実行 → 本番 ON

例外／個別判断が必要なケース
• レコード件数が極小（≦ 数十件）で、Map 化の前処理コストが勝たない場合
→ 可読性優先でそのままでも可。ただし将来増える見込みなら今のうちに Map 化。
• 部分失敗の自動回収（今回スキップ可）
→ 実運用で部分失敗が見えたら後付けで実装。新媒体追加の作業性には影響小。

ドキュメントと Git 運用（共通）
• README の各ファイルセクションに
• 役割 / 動作ビュー / 主な機能 / 最近の改善（年月） / 既知の注意点
• TEST.md に各ファイルの A/B/C テスト項目を追記。
• コミット例：

feat: XX の辞書化＋ Map 参照化＋ DRY_RUN/DEBUG 配線

- switch 撤廃、定数に集約
- find/filter を Map.get に置換（O(N)→O(1)）
- 取得を fields 最小化＋ IN 句＋チャンク(100)
- TEST.md に A テスト追記

  • タグは フェーズ単位（例：v2025-10-PhaseX）で付与。

⸻

結論：同じ型で横展開して OK です。
次に触るファイル名を教えていただければ、置換ポイント候補（grep パターン）と差し替えスニペットをすぐ出します。
