# Kintone 出荷指示アプリ カスタマイズ JS

このリポジトリは、Kintone の「出荷指示アプリ」で使用される JavaScript カスタマイズファイルを管理します。
各ファイルは特定の業務プロセスを自動化・効率化するための機能を提供します。

## ファイル構成と役割

### 1. `0_指定出荷日を入力_250217.js`

- **役割:** 指定出荷日の一括入力
- **動作ビュー ID:** `6428047`
- **機能:**
  - 一覧画面に「指定出荷日を入力」ボタンを追加します。
  - ボタンをクリックすると、対象の媒体（全媒体または個別）と出荷日を選択するダイアログが表示されます。
  - 選択された内容に基づき、一覧に表示されている対象レコードの「指定出荷日」フィールドを一括で更新します。

### 2. `1_出荷依頼を出力_250618_1.js`

- **役割:** 出荷依頼 CSV のダウンロード
- **動作ビュー ID:** `6426714`
- **機能:**
  - 一覧画面に「出荷依頼データを DL」および「出荷依頼データを DL(HC 確認用)」ボタンを追加します。
  - 一覧に表示されているレコードを元に、配送業者に応じたフォーマットで出荷依頼 CSV ファイルを生成し、ダウンロードします。
  - 通常のダウンロード（HC 確認用でない方）の場合、処理後に各レコードの「出荷依頼 CSV の出力日」フィールドを更新します。

### 3. `2_伝票番号の取込_250213.js`

- **役割:** 伝票番号 CSV の取り込み
- **動作ビュー ID:** `6427059`
- **機能:**
  - 一覧画面に「伝票番号 CSV を UL」ボタンを追加します。
  - ボタンをクリックして CSV ファイルを選択すると、ファイルの内容を読み込みます。
  - CSV に含まれるレコード番号と伝票番号をキーにして、該当するレコードの「伝票番号」「発送日」「伝票番号 CSV の取込日」フィールドを更新します。

### 4. `3_出荷管理に伝票番号を反映_250225.js`

- **役割:** 関連アプリへの伝票番号反映
- **動作ビュー ID:** `6428145`
- **機能:**
  - 一覧画面に「各モールの出荷管理に伝票番号を反映」ボタンを追加します。
  - 一覧に表示されているレコードの伝票番号や発送日などの情報を、レコードごとに指定された関連アプリ（各 EC モールの出荷管理アプリ）に転記・反映します。
  - 反映後、元の出荷指示アプリのレコードにある「出荷管理へ反映日」フィールドを更新します。

### 5. `0_各モールの注文データを収集_250626.js`

- **役割:** 各モール（くまポン、WELBOX、eecoto、リロクラブ、ベネフィット・ワン、T ポイント、社販、坂戸以外、KAUCHE）の出荷管理アプリから「出荷依頼」ステータスのレコードを収集し、出荷指示アプリに新規レコードとして登録します。
- **動作ビュー ID:** `6428047`
- **機能:**
  - 一覧画面に「各モールの注文データを収集」ボタンを追加
  - ボタンクリック時、各出荷管理アプリから「出荷依頼」ステータスのレコードを取得
  - 取得データと **案件管理 / 商品マスタ / 在庫管理 / 倉庫マスタ** を突合して出荷指示用レコードを生成
  - 生成レコードに **出荷管理のレコード URL 付与／住所不備チェック／電話番号補正** を実施
  - 出荷指示アプリへ一括登録
  - 登録後、元の出荷管理側の「運用ステータス」を **出荷依頼済み** に更新
  - 処理結果をポップアップ通知
  - **BEAUTH（Shopify / eecoto）のクーポン判定（2025-09）**: 出荷管理 BEAUTH（アプリ ID: 568）で **注文メモ**（`注文メモ`）を判定し、出荷指示（アプリ ID: 583）の **記事欄 5**（`記事欄5`）へ自動入力。
    - `ANA` を含む場合 → 「ANA Pocket 分」
    - `JAL` を含む場合 → 「JAL ミニマイル特典分」
    - それ以外（記載なし含む） → 空欄
    - 判定は大文字小文字を無視（`toUpperCase().trim()`）、両方含まれる場合は **ANA を優先**
  - **WELBOX** の場合は記事欄 1（`記事欄1`）に「WELBOX」を自動入力

#### 最近の改善（2025-09）

- 出荷管理の取得を **並列化**、429/5xx を **指数バックオフ**（最大 3 回）で再試行
- 案件 / 商品 / 在庫の取得を **in(...)＋ 100 件チャンク** に統一し、`fields` 最小化で転送量を削減
- 出荷管理側の一括更新に **簡易リトライ**を追加し、**媒体別サマリ（成功/失敗件数）**を表示
- **商品コードキーの正規化**を導入（`normalizeCode()` により空白・全角/半角・大文字小文字を統一、空コードは除外）
- **倉庫マスタのフォールバック**を導入（103 → 104 → 先頭レコードの順で選択、無ければ null）
- **在庫配列を賞味期限昇順にソート**し、最短賞味期限から割当て
- **二重起動ガード**（ボタン disable ＋「処理中…」表示）を追加
- ログは **DEBUG フラグ**で詳細化（通常は要点のみ）

---

### テスト優先度

#### 優先度 A（必須）

1. **README 差し替え反映**（上記ブロックに統一）
2. **媒体別の最小動作テスト**
   - くまポン（媒体名未指定=デフォルトくまポン）
   - WELBOX（記事欄 1= WELBOX）
   - eecoto（注文メモ= ANA / JAL / 空欄 → 記事欄 5 判定）
3. **並列取得・バックオフの確認**（DEBUG = true でログ確認）

#### 優先度 B（次にやる）

4. **ITEM_BY_CODE / STOCK_BY_CODE の構築確認**（正規化＋賞味期限昇順ソート）
5. **在庫割当の境界テスト**（必要数ちょうど/不足/複数在庫パターン）
6. **倉庫フォールバック確認**（103 → 104 → 先頭 → null の順）

#### 優先度 C（仕上げ）

7. **住所・電話補正の確認**（郵便番号ゼロパディング、電話の +81→0 変換）
8. **二重起動ガード UI 確認**（処理中ボタン disable / 処理終了で解除）
9. **日付フォーマットの揺れ対応テスト**（坂戸以外・KAUCHE / T ポイント）

---

### 6. `test.js`

- **役割:** `0_各モールの注文データを収集_250626.js` と同じ内容のテスト用ファイルです。
- **動作ビュー ID:** `6428047`
- **機能:** `0_各モールの注文データを収集_250626.js` と同様の機能を提供します。

### 7. `0_BtoB_指定出荷日を入力_250221 (1).js`

- **役割:** BtoB 案件向けに、指定した媒体（または全媒体）のレコードに対して指定出荷日を一括で設定し、関連する入出庫管理アプリに納品データを登録します。
- **動作ビュー ID:** `6428141`
- **機能:**
  - 一覧画面に「指定出荷日を入力」ボタンを追加します。
  - ボタンクリック時、対象媒体（Ponta パス、V サンプル、または全媒体）と出荷日を選択するダイアログが表示されます。
  - 選択された媒体と出荷日に基づき、一覧に表示されている対象レコードの「指定出荷日」フィールドを更新します。
  - 出荷指示アプリのレコード更新後、指定出荷日の翌日を納品予定日として、入出庫管理アプリに納品データを自動で登録します。
  - 処理結果はポップアップで通知されます。

### 9. `1_BtoB_出荷依頼を出力_250618_1.js`

- **役割:** BtoB 案件の出荷依頼データを CSV 形式でダウンロードします。
- **動作ビュー ID:** `6427848`
- **機能:**
  - 一覧画面に「BtoB 出荷依頼データを DL」ボタンと「テスト: CSV DL」ボタンを追加します。
  - 「BtoB 出荷依頼データを DL」ボタンクリック時、現在のビューに表示されているレコードから商品情報、配送先情報などを集約し、指定されたフォーマットで CSV ファイルを生成してダウンロードします。ダウンロード後、対象レコードの「出荷依頼 CSV の出力日」フィールドを更新します。
  - 「テスト: CSV DL」ボタンクリック時、同様に CSV ファイルを生成しますが、テスト用としてファイル名に`_TEST`が付与されます。
  - レコードの作成・編集時、ご依頼主名や媒体名に基づいてご依頼主電話番号を自動補正します。

### 10. `1_出荷依頼を出力_250618_1.js`

- **役割:** 出荷依頼データを CSV 形式でダウンロードします。HC（ハッピーキャンペーン）ユーザーの場合はダウンロードのみで、CSV 出力日の更新は行いません。
- **動作ビュー ID:** `6426714`
- **機能:**
  - 一覧画面に「出荷依頼データを DL」ボタンと「出荷依頼データを DL(HC 確認用)」ボタンを追加します。
  - 「出荷依頼データを DL」ボタンクリック時、現在のビューに表示されているレコードから商品情報、配送先情報などを集約し、配送業者（佐川急便、ゆうパケット）に応じたフォーマットで CSV ファイルを生成してダウンロードします。ダウンロード後、対象レコードの「出荷依頼 CSV の出力日」フィールドを更新します。
  - 「出荷依頼データを DL(HC 確認用)」ボタンクリック時も同様に CSV ファイルを生成してダウンロードしますが、HC ユーザー向けのため「出荷依頼 CSV の出力日」フィールドは更新しません。
  - レコードの作成・編集時イベントで、ご依頼主名や媒体名に基づいてご依頼主電話番号を自動補正します。
  - 住所を都道府県と市区町村以降に分割する処理を含みます。
  - CSV 出力時に、ご依頼主コード（サイズに応じて変化）、電話番号のハイフン除去、賞味期限のフォーマット変換など、項目に応じた値の変換を行います。

### 11. `2_BtoB_伝票番号の取込_250401_3.js`

- **役割:** BtoB 案件の伝票番号 CSV ファイルを取り込み、出荷指示アプリの該当レコードに伝票番号、発送日、伝票番号 CSV の取込日を反映します。
- **動作ビュー ID:** `6427850`
- **機能:**
  - 一覧画面に「BtoB 伝票番号 CSV を UL」ボタンと「テスト機能実行」ボタンを追加します。
  - ボタンクリック時、CSV ファイルを選択するダイアログが表示され、選択された CSV ファイルの内容を読み込みます。
  - CSV データと現在のビューに表示されているレコードを比較し、指定出荷日、商品コード、賞味期限が一致するレコードに対して伝票番号、発送日、伝票番号 CSV の取込日を更新します。
  - 「テスト機能実行」ボタンクリック時も同様に CSV ファイルを読み込みますが、レコードの更新は行わず、処理のシミュレーションのみを行います。
  - 処理結果はポップアップで通知されます。

### 12. `2_伝票番号の取込_250213.js`

- **役割:** 伝票番号 CSV ファイルを取り込み、出荷指示アプリの該当レコードに伝票番号、発送日、伝票番号 CSV の取込日を反映します。
- **動作ビュー ID:** `6427059`
- **機能:**
  - 一覧画面に「伝票番号 CSV を UL」ボタンを追加します。
  - ボタンクリック時、CSV ファイルを選択するダイアログが表示され、選択された CSV ファイルの内容を読み込みます。
  - CSV データ（伝票番号、レコード ID、発送日）を基に、出荷指示アプリの該当レコードを更新します。
  - 処理結果はポップアップで通知されます。

### 13. `4_BtoB_ピッキング明細を出力_250526.js`

- **役割:** BtoB 案件の伝票番号取込済みのレコードから、指定した月のピッキング費用明細を CSV 形式で出力します。
- **動作ビュー ID:** `6427852`
- **機能:**
  - 一覧画面に「BtoB ピッキング明細を出力」ボタンを追加します。
  - ボタンクリック時、出力対象の月（今月、先月、先々月）を選択するダイアログが表示されます。
  - 選択された月に該当し、かつ伝票番号が取り込まれている BtoB 案件のレコードを Kintone から取得します。
  - 取得したレコードの商品情報をフラット化し、ピッキング単価や注文数に応じた計算を行い、CSV 形式で出力します。
  - CSV ファイル名には、出力日と対象月が含まれます。
  - 処理結果はポップアップで通知されます。

### 14. `4_出荷実績を出力_250330.js`

- **役割:** 伝票番号が取り込まれたレコードから、指定した月の出荷実績を CSV 形式で出力します。BtoB 案件ではないレコードが対象です。
- **動作ビュー ID:** `6427178`
- **機能:**
  - 一覧画面に「出荷実績を出力」ボタンを追加します。
  - ボタンクリック時、出力対象の月（今月、先月、先々月）を選択するダイアログが表示されます。
  - 選択された月に該当し、かつ伝票番号が取り込まれている BtoB ではない案件のレコードを Kintone から取得します。
  - 取得したレコードの情報を CSV 形式に変換し、出力します。
  - CSV ファイル名には、出力日と対象月が含まれます。
  - 処理結果はポップアップで通知されます。

### 15. `5_電話番号補正処理_共通_250526.js`

- **役割:** 電話番号の補正処理を実行します。
- **動作ビュー ID:** 全てのビュー（`app.record.index.show`イベントでビュー ID の指定がないため）
- **機能:**
  - 一覧画面表示時に`updatePhoneNumbers`関数を実行します。
  - 「📞 電話番号補正（手動実行）」ボタンをヘッダーメニューに追加し、クリックすることで手動で`updatePhoneNumbers`関数を実行できます。
  - `updatePhoneNumbers`関数は現在仮の実装であり、具体的な電話番号補正ロジックは含まれていません（`TODO`コメントあり）。

16. 計算\_セット入数合計.js
    • 役割: サブテーブル「商品情報」の「個数」合計とレコードの「注文数」から「セット入数合計」を自動計算します。
    • 動作ビュー ID: 新規作成・編集画面（app.record.create.show, app.record.edit.show）、保存時（app.record.create.submit, app.record.edit.submit）
    • 機能:
    • サブテーブル「商品情報」内の「個数」値を合計します。
    • 合計値を「注文数」で割り、計算結果を「セット入数合計」に反映します。
    • 「個数」または「注文数」が変更された場合はリアルタイムで再計算します。
    • 保存時にも必ず再計算を行い、整合性を担保します。
    • 既存レコードについては一時的に「一括埋め込み」ボタンで更新対応済み（現在は削除済み）。

## JS ファイルの読み込み順序について

各 JavaScript ファイルは、それぞれが独立して動作するように設計されています。
具体的には、以下の理由により、**kintone のカスタマイズ設定でこれらのファイルを読み込む順番を気にする必要はありません。**

- **イベントハンドラの分離:** 各ファイルは、異なるビュー ID (`viewId`) を持つ `app.record.index.show` イベントをリッスンしており、同時に実行されることはありません。
- **スコープの独立性:** すべてのコードは即時実行関数式 `(() => { ... })();` で囲まれており、グローバルスコープの汚染を防いでいるため、ファイル間で変数名や関数名が衝突することはありません。
- **機能の独立性:** ファイル間で関数を呼び出したり、変数やオブジェクトを共有したりする依存関係はありません。

## 運用上の注意

- 429/5xx エラー時は自動リトライします。最大 3 回まで再試行するため、失敗が続く場合は処理時間が延びます。
- DEBUG フラグを true にすると詳細ログを出力します。通常運用では OFF を推奨します。
- ボタン連打を防ぐため、処理中はボタンが無効化されます。

## 変更履歴

- 2025-09-26 `0_各モールの注文データを収集_250626.js`
  - 出荷管理取得を並列化＋指数バックオフを追加
  - 案件/商品/在庫取得を in 句＋チャンク化し、fields 最小化
  - 出荷管理の一括更新にリトライ・媒体別サマリを追加
  - 二重起動ガード・DEBUG 切替を実装
