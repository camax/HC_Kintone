🧾 売価計算アプリ（App ID: 483）README

InputControl.js 完成版

> 🆕 2025-10-21 更新：TEMU / WELBOX 対応を反映した**最新の安定動作版**として確定。
>
> ✅ InputControl.js（旧 01_2_1 / 01_2_2 統合版）を実装。
>
> - 商品情報一覧の初期生成・入力可否制御を一元管理。
> - **「希望小売価格バラ（税抜）」および「仕入れバラ（税抜）」は、商品マスタ連携の有無にかかわらず常に手入力可能です。**
> - 旧来のルックアップ連携後もこれらの価格欄は直接編集できます（lookup 連携後も非活性化しません）。
> - DEBUG 切替機能（URL / localStorage）を追加。
> - 本版で TEMU / WELBOX 対応を含む安定動作を確認済み。
> - **本ファイルが現行の最新版・安定版です（2025-10-21 時点）**

📘 概要

本アプリは、各モール（au／くまポン／FiNC／リロ／ベネ／社販／Temu 等）の
売価計算・採用管理・利益率集計・掲載依頼アプリへの連携 を自動化する仕組みです。

主な目的は以下の通りです：
• サブテーブル「商品情報一覧」の自動生成・初期値設定
• 商品マスタ連携に応じた入力可否制御
• 採用フラグによるモール別売価・利益反映
• 採用モールごとの売上／利益／セット数合計算出
• 平均値／ゼロ補完の自動計算
• 掲載依頼アプリへの自動転送（API 連携）

⸻

📄 **InputControl.js についての重要なお知らせ**

- 旧ファイル `01_2_1_SetStyle_ItemSubTable_250512.js` および `01_2_2_SetStyle_FieldsStyle_250512_2.js` は、`InputControl.js` のリリースにより**廃止・非推奨**となりました。
- 今後は `InputControl.js` のみを利用してください（上記 2 ファイルは保守対象外です）。

## 🔧 今後のアクション（Next Steps）

### 🔍 動作検証チェックリスト（App ID: 483）

| 項目               | 対象                                | 確認方法       | 想定結果                                  |
| ------------------ | ----------------------------------- | -------------- | ----------------------------------------- |
| TEMU 採用フラグ    | `案件採用_TEMU`                     | ON にして保存  | TEMU 欄の売価・利益・セット数が反映される |
| WELBOX 採用フラグ  | `案件採用_WELBOX`                   | ON にして保存  | WELBOX 欄に反映される                     |
| 採用解除時         | 各媒体                              | OFF にして保存 | 対象モール欄の値がクリアされる            |
| 合計算出           | 媒体売上合計・媒体利益合計          | 再計算後に確認 | TEMU／WELBOX 分が含まれる                 |
| 掲載依頼アプリ連携 | CreateRecodeToPostingRequest ボタン | 押下           | TEMU／WELBOX の行が新規 or 更新登録される |

---

### ⚙️ 改善フェーズ（推奨）

今後新媒体が増える場合を見据えて、以下の 3 点の改善を推奨。

| 改善項目                  | 目的                                         | 工数目安     |
| ------------------------- | -------------------------------------------- | ------------ |
| **A. InputControl 統合**  | `01_2_1`＋`01_2_2`を 1 本化して管理性 UP     | 約 3〜4 時間 |
| **B. 採用フラグ共通化**   | `applyMallValues()`関数化で 1 箇所修正対応   | 約 4〜6 時間 |
| **C. サブテーブル動的化** | 固定 10 行 →forEach 化（モール数増加に強い） | 約 2 時間    |

> ※ 2025-10-21 時点では TEMU / WELBOX の安定稼働を確認済み。  
>  今後の改善はモール共通化と InputControl 統合が中心となります。

> TEMU 追加直後の「安定稼働確認 → A〜C 実施」の順が理想。

---

### 🧭 実務上のタスク整理（優先順）

1. **Kintone フィールド名確認**  
   `案件採用_TEMU`／`案件採用_WELBOX`  
   `売価_税抜_TEMU`／`売価_税抜_WELBOX`

2. **掲載依頼アプリのフィールド追加**  
   TEMU／WELBOX の売価・納価・利益・利益率を追加

3. **CreateRecodeToPostingRequest の動作テスト**  
   採用フラグ ON レコードで掲載依頼アプリへ転送確認

4. **README の Git コミット**
   ```
   git add README.md
   git commit -m "docs: TEMU/WELBOX対応後の次ステップ追記"
   git push origin main
   ```

---

### 🧱 今後の構成拡張（モジュール化案）

```
/売価計算/
├─ modules/
│  ├─ SubTableGenerator.js
│  ├─ InputControl.js
│  ├─ ZeroFill.js
│  ├─ MallPriceHandler.js
│  ├─ AvgCalculator.js
│  └─ PostingRequestSync.js
└─ main.js
```

> 媒体追加時に mallGroups 配列へ 1 行追加するだけで対応可能。

📂 ファイル構成と処理概要

### 📑 推奨 JS ファイル掲載順（読み込み順）

1. 01_1_CreateRecodeToPostingRequest_250703.js
2. 01_2_3_SetStyle_FieldsStyleChangeItemCode_250512.js
3. 01*4*ケース入数\_ゼロ埋め処理\_20250512_5.js
4. InputControl.js（旧 01_2_1 / 01_2_2 統合版）
5. 01_3_SetValue_MallSellingPrice_240404.js
6. 01_3_SetValue_SumValue_250204.js
7. 01_3_SetValue_OrderQuantityTotal_250610_2.js
8. 01_3_SetValue_ValueRiroAndBeneAndShahan_250703.js

### 📘 統合確認と旧ファイルの配置順

> **統合対象ファイル（旧順序と対応）**
>
> | 旧順 | 旧ファイル名                            | 主な機能                                         | 現行対応                                            |
> | ---- | --------------------------------------- | ------------------------------------------------ | --------------------------------------------------- |
> | ②    | 01_2_1_SetStyle_ItemSubTable_250512.js  | 商品情報一覧 10 行生成・商品コード／シリアル採番 | InputControl.js の `generateItemSubTable()` に統合  |
> | ③    | 01_2_2_SetStyle_FieldsStyle_250512_2.js | 商品情報一覧の活性／非活性制御                   | InputControl.js の `setFieldAccessibility()` に統合 |
>
> - 両ファイルを同時に読み込むと、商品情報一覧が二重生成される可能性があります。
> - 現行環境では **InputControl.js のみ有効化**し、旧 `01_2_1` および `01_2_2` は **削除または退避フォルダへ移動**してください。

> ※ 上記順に Kintone カスタマイズ画面で登録することで、依存関係・イベントトリガー順序が正しく動作します。
> 特に InputControl.js は初期化と入力制御の中核モジュールです。

> **[重要]**  
> `InputControl.js` が `01_2_1_SetStyle_ItemSubTable_250512.js` および `01_2_2_SetStyle_FieldsStyle_250512_2.js` の機能を完全に統合し、置き換えています。旧ファイルは今後使用しないでください。

No ファイル名 主な機能 トリガー 概要
01 01*2_3_SetStyle_FieldsStyleChangeItemCode_250512.js 商品情報一覧の初期生成 app.record.create.show 商品情報一覧を 10 行固定で生成。商品一覧 ID・商品コード（hc000x）・シリアルコード（HC-xx）を自動採番。
02 01_4*ケース入数*ゼロ埋め処理\_20250512_5.js ケース入数ゼロ補完 app.record.create/edit.change.商品情報一覧*ケース入数 「ケース入数」欄が空の場合に自動で 0 をセット。欠損キーの検出・ログ出力付き。
03 01_2_2_SetStyle_FieldsStyle_250512_2.js ルックアップによる入力制御 商品コード／商品レコード ID 変更時 商品マスター連携済商品のケース入数・希望小売価格・仕入れ価格を非活性化。
04 01_2_1_SetStyle_ItemSubTable_250512.js サブテーブル活性制御 app.record.create.show, app.record.edit.show 商品レコード ID の有無に応じて、希望小売価格・ケース入数等の編集可否を切替。アプリ連携項目を非活性化。
05 01_3_SetValue_MallSellingPrice_240404.js 採用フラグ → モール反映 各モールの 採用フラグ\_x 変更 採用フラグ ON で該当シミュレーション行の売価・納価・利益をモールへコピー。売上・損益分岐点を再計算。
06 01_3_SetValue_SumValue_250204.js 採用モール合計算出 案件採用・売上・利益変更 採用中モールの「セット数」「売上」「利益」を合計し、媒体セット数合計／媒体売上合計／媒体利益合計に反映。
07 01_3_SetValue_OrderQuantityTotal_250610_2.js サブテーブル平均値算出 保存時 発注バラ数・希望小売価格バラ・仕入れバラの平均を計算し、平均フィールドに反映。
08 01_1_CreateRecodeToPostingRequest_250703.js 掲載依頼アプリ連携 詳細画面ボタン押下 売価計算レコード内容を掲載依頼アプリに新規作成または更新。サブテーブルを展開して個別フィールドに転送。
09 01_3_SetValue_ValueRiroAndBeneAndShahan_250703.js 売価コピー試験コード （未使用） くまポン／au 採用時に他媒体へ売価をコピーするテスト実装。実運用では無効化推奨。

⸻

⚙️ 処理フロー（全体像）

新規レコード作成
├─ (1) 商品情報一覧 10 行生成 ［01_2_3］
├─ (2) ケース入数ゼロ埋め ［01_4］
├─ (3) 商品コード選択時の活性制御 ［01_2_2, 01_2_1］
├─ (4) 採用フラグ選択 → モール売価反映 ［01_3_MallSellingPrice］
├─ (5) 各モールの売上・利益合計 ［01_3_SumValue］
├─ (6) 平均値算出（保存時）［01_3_OrderQuantityTotal］
└─ (7) 掲載依頼アプリに反映ボタン実行［01_1_CreateRecode］

⸻

---

## 📝 Changelog & 安定性

- 2025-10-21: `InputControl.js` 最新安定版に更新。TEMU/WELBOX 対応とともに、「希望小売価格バラ（税抜）」および「仕入れバラ（税抜）」が**lookup 連携済みでも手入力可能**となるよう修正。  
  旧 `01_2_1_SetStyle_ItemSubTable_250512.js` および `01_2_2_SetStyle_FieldsStyle_250512_2.js` は廃止・非推奨（deprecated）となりました。
- **現行バージョンは安定運用中です。**  
  以降の更新は新媒体追加・モール共通化が中心となります。

🧩 データ連携仕様

売価計算 → 掲載依頼アプリ

種別 対応項目 備考
採用情報 案件採用*モール名 チェック ON モールのみ送信
売価関連 売価*税抜\_xx / 納価\_xx / HC 利益率\_xx リロ・ベネ・社販系は「納価」、他は「売価」
商品情報 商品コード\_i, 希望小売価格\_i, 仕入れ\_i, 最安値 URL_i サブテーブルを展開して個別転送
配送情報 配送サイズ名, 資材名, 緩衝材費有無 等 各モール共通
リンク情報 掲載依頼レコード ID, 掲載依頼レコード URL 売価計算に保持（双方向参照可）

⸻

🧮 集計・計算仕様

フィールド 算出式 トリガー
売上*税抜\_xx 売価*税抜*xx × セット数\_xx 採用フラグ変更時
セット利益\_xx HC 利益*税抜*xx × セット数\_xx 同上
損益分岐点\_xx 合計*発注金額 × (合計*セット仕入価格 + セット利益) 同上
媒体売上合計*税抜 採用モールの売上合計 モール採用・数値変更時
媒体利益合計 採用モールの利益合計 同上
媒体セット数合計 採用モールのセット数合計 同上
各平均値 サブテーブル平均（Math.floor） 保存時

⸻

🧱 現行構成の課題・改善提案

分類 対象 問題点 改善案
冗長処理 採用フラグ処理（MallSellingPrice） 各モールで同様の記述を繰り返し applyMallValues(record, baseCode, mallList)関数化で共通化
ログ過多 ゼロ埋め処理 console.log や console.warn が多い DEBUG フラグ導入で制御
処理重複 01_2_1 と 01_2_2 活性制御が二重管理 InputControl.js として統合
固定値依存 サブテーブルループ for(let i=0;i<10;i++)で固定 .forEach()に変更し可変対応
例外処理不足 掲載依頼連携 SweetAlert 後の処理継続 return event で制御終了を明示
構造 各スクリプトが独立 IIFE 全体統制しにくい HC.PriceApp モジュールに統合し init()で制御一括化

⸻

🕒 改善作業の想定所要時間（実装＋テスト込み）

区分 内容 想定時間
A. InputControl 統合 01_2_1 ＋ 01_2_2 を 1 本化 約 3〜4 時間
B. 採用フラグ共通化 SetDisabled 再構成＋関数化 約 4〜6 時間
C. サブテーブル動的化 固定 10 行 →forEach 化 約 2 時間
D. ログ制御統一 DEBUG フラグ追加 約 1 時間
E. 掲載依頼例外処理改善 SweetAlert 後挙動整備 約 2〜3 時間
F. README 改訂 modules 構造準拠に更新 約 1.5 時間
G. 結合テスト 全イベント検証・保存確認 約 3 時間

合計目安：15〜18 時間（2 営業日程度）
軽量対応（A ＋ C ＋ D のみ）なら 約 6〜7 時間。

⸻

🧭 改善タイミングの判断

状況 推奨方針
新媒体を今後も追加予定（Temu, FiNC など） 改善を先に行う。以後の媒体追加コストを 30〜40％削減できる。
単発で Temu のみ追加予定 改善は後回しでも OK。ただし README だけは更新しておく。
外部公開・稼働中 まず新媒体対応を優先し、安定後に段階的リファクタリングを実施。

⸻

📦 推奨フォルダ構成（改善後）

/売価計算/
├─ HC.js # 共通定義（apps/malls/domain）
├─ main.js # 初期化スクリプト
├─ modules/
│ ├─ SubTableGenerator.js # 商品情報一覧生成
│ ├─ InputControl.js # 入力制御統合
│ ├─ ZeroFill.js # ゼロ補完
│ ├─ MallPriceHandler.js # 採用反映・合計集計
│ ├─ AvgCalculator.js # 平均算出
│ └─ PostingRequestSync.js # 掲載依頼連携
└─ README.md

⸻

⚙️ 新媒体追加時の留意点

項目 内容
追加場所 MallPriceHandler.js のモール配列 (const mallGroups = [...]) に媒体名を追加
必要設定 売価・納価・利益率・採用フラグの各フィールドコードを命名規則に沿って追加（例：売価\_税抜\_temu）
関連アプリ連携 掲載依頼アプリにも同名フィールドを追加（双方向対応）
改善実施済みか 改善前でも追加可能だが、モール処理の重複が多くなる。改善後だと 1 行追加で完結。

⸻

✅ 総評
• 現行コードは安定稼働しており、段階的リファクタリングが容易。
• ただし今後モールが増える場合は事前改善が断然有利。
• Temu 追加を機に、InputControl 統合と採用反映共通化だけでも先に実施すると、
次の媒体対応が劇的に楽になります。

⸻

最終推奨フロー（Temu 対応＋保守安定型） 1. Temu 項目を既存構造に追加（現行スクリプトベース） 2. README を Git に保存（この版） 3. 機能安定後に modules 化（A〜C 実施） 4. 掲載依頼アプリとの連携確認 5. MallPriceHandler を汎用化し、新媒体追加を 1 行対応化

⸻
