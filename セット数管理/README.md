# 🧩 セット数管理アプリ（ID 501）

## 📘 概要

「セット数管理アプリ」は、各モール（au・T サンプル・くまポンなど）の  
セット在庫数・申込数・残数を一元管理し、  
**発注書アプリ** および **案件管理アプリ** と連携して  
発注・在庫移動・案件反映を自動化する中核アプリです。

---

## 🔗 連携アプリ

| 連携アプリ名 | アプリ ID 変数        | 目的                       |
| ------------ | --------------------- | -------------------------- |
| 案件管理     | `HC.apps.案件管理.id` | 案件ごとのセット数を同期   |
| 発注書       | `HC.apps.発注書.id`   | 追加発注書の作成・発行確認 |

---

## 🧾 フィールド構造（主要）

| フィールド名                                                                         | 内容／用途                         | 種別                     |
| ------------------------------------------------------------------------------------ | ---------------------------------- | ------------------------ |
| **案件グループ ID**                                                                  | 案件管理アプリとの紐付けキー       | 文字列（1 行）           |
| **掲載商品名（au/T サンプル）**                                                      | 商品名                             | 文字列（1 行）           |
| **セット数合計／申込数合計／残セット数合計**                                         | 集計値                             | 数値                     |
| **セット数（各モール別）**                                                           | 在庫数（モール別）                 | 数値                     |
| **累計申込数（各モール別）**                                                         | モール別申込数合計                 | 数値                     |
| **残セット数（各モール別）**                                                         | 在庫残                             | 数値                     |
| **案件管理にセット数を反映［反映済み］**                                             | 案件管理への反映ステータス         | チェックボックス／文字列 |
| **変更日／増減数量／変更元／変更先／追加発注の発注書／掲載モール反映チェック／備考** | 「総セット数変更履歴」テーブル構成 | テーブル                 |

---

## 📊 テーブル構造：「総セット数変更履歴」

| 項目                   | 説明                         |
| ---------------------- | ---------------------------- |
| 変更日                 | 在庫・発注反映日（自動入力） |
| 増減数量               | セット数の増減値（数値）     |
| 変更元                 | 減算対象モール名             |
| 変更先                 | 加算対象モール名             |
| 追加発注の発注書       | 発注書番号（自動入力）       |
| 掲載モール反映チェック | 発注反映済みフラグ           |
| 備考                   | メモ欄                       |

---

## ⚙️ JS ファイル対応マップ

| JS ファイル                                       | 対象フィールド                                              | 主な機能                                 |
| ------------------------------------------------- | ----------------------------------------------------------- | ---------------------------------------- |
| **05_1_CreateAdditionalOrder_240708.js**          | 総セット数変更履歴（変更元／変更先／発注書）                | 追加発注書を自動作成（発注書アプリ連携） |
| **05_2_CheckAdditionalAndUpdateSetNum_240325.js** | 総セット数変更履歴（発注書・変更日）／各モールのセット数    | 発注書発行確認後にモール在庫を加算       |
| **05_3_UpdateMatterSetNum_240324.js**             | 案件グループ ID／案件管理にセット数を反映／各モールセット数 | 案件管理アプリのセット数更新             |
| **05_4_ApplySetNumFromTable_240708.js**           | 総セット数変更履歴（変更元・変更先・変更日・増減数量）      | テーブル内容を各モールのセット数へ反映   |
| **05_5_DisableEdit_240708.js**                    | 総セット数変更履歴（変更日・発注書）／各モールセット数      | 編集画面でのフィールド編集禁止           |
| **05_6_HandleInventoryTransfer_250619.js**        | セット数変更履歴（変更元・変更先・増減数量）                | 在庫移動処理（モール間在庫の加減算）     |

---

## 🔁 処理フロー（業務順）

1. **追加発注を登録**

   - テーブルに追加発注情報を入力
   - 「追加発注の発注書を作成」ボタンで発注書アプリに新規作成
   - 発注番号がテーブルに記録される

2. **発注書の発行**

   - 発注書アプリで「発注書ドライブ保存日」を入力

3. **発行確認**

   - 「発注書の発行確認」ボタンを実行
   - 「変更日」に保存日が反映され、各モール在庫が加算

4. **案件管理へ反映**

   - 「案件管理のセット数を更新」ボタン実行
   - 案件管理アプリにモール別セット数を反映

5. **在庫移動（必要時）**

   - 「変更元」「変更先」「増減数量」を入力
   - 保存時に在庫がモール間で自動移動

6. **履歴から直接反映（変更日未入力分）**
   - 「各モールのセット数を更新」ボタンで反映処理

---

## 🧱 データ入出力構造

| 区分     | 対象               | 入出力内容                         |
| -------- | ------------------ | ---------------------------------- |
| 入力     | 総セット数変更履歴 | 手動入力 or JS 更新                |
| 出力     | 発注書アプリ       | 追加発注レコード作成（05_1）       |
| 出力     | 案件管理アプリ     | セット数反映（05_3）               |
| 出力     | 各モールセット数   | 増減・移動反映（05_2, 05_4, 05_6） |
| 入力制御 | 編集画面           | DisableEdit（05_5）                |

---

## 💡 メンテナンス Tips

- 在庫移動（05_6）は「変更元」「変更先」「増減数量」を必ず入力
- 変更元と変更先が同一モールの場合はエラー表示
- 編集画面では「変更日」「発注書」「セット数」は変更不可
- 新規 JS 追加時は `kintone.events.on` のイベント重複に注意

---

## 🧭 備考

- アプリ ID：**501**
- モール対応フィールド例：
  - au → `セット数_au`
  - T サンプル → `セット数_Tサンプル`
  - ベネフィット → `セット数_ベネ`
  - 社販 → `セット数_社販`
- 発注書の自動採番形式：`HCH-YYYYMMDD-n`

---

© 2025 HC Systems - Kintone Customization
